import{az as _e,l as Ve,ae as Be,a2 as N,R as q,u as U,ag as te,j as e,aX as Ue,f as M,dx as le,B as d,D as oe,w as Me,x as He,aR as $e,y as Oe,z as ze,I as Ke,J as Qe,bH as ce,bI as de,bJ as D,bK as n,bL as he,bM as t,aB as Je,bh as xe,g as me,h as ue,ab as Ge,i as pe,a4 as We,O as Xe,Q as H,V as $,W as O,Y as z,_ as h,au as Ye,M as Ze,cw as ea,cx as aa,cz as x,cy as sa,cA as E,dy as ge,cB as ra,aq as je,o as k,K as ve,ax as ia,r as na,a1 as ta}from"./index-D5qLf1ib.js";import{H as la}from"./Helmet-BNepwt1P.js";import{S as L}from"./skeleton-XQWc31Aw.js";import{C as oa}from"./circle-check-BnS-MIcE.js";function ua(){var Y,Z,ee,ae;const[,K]=_e(),{toast:l}=Ve(),Q=Be(),[r,T]=N.useState(1),[u,be]=N.useState(""),[p,fe]=N.useState("all"),[g,Ne]=N.useState("all"),[j,ye]=N.useState("all"),[w,I]=N.useState([]),[Ce,P]=N.useState(!1),y=q.useRef(null),{data:F,isLoading:we}=U({queryKey:["/api/parks"],queryFn:async()=>{const a=await fetch("/api/parks");if(!a.ok)throw new Error("Error al cargar los parques");return a.json()},suspense:!1,retry:1}),R=(F==null?void 0:F.data)||[],{data:A,isLoading:Se}=U({queryKey:["/api/tree-species"],queryFn:async()=>{const a=await fetch("/api/tree-species");if(!a.ok)throw new Error("Error al cargar las especies arbóreas");return a.json()},suspense:!1,retry:1}),{data:s,isLoading:Ee,error:J}=U({queryKey:["/api/trees",r,u,p,g,j],queryFn:async()=>{let a=`/api/trees?page=${r}&limit=10`;u&&(a+=`&search=${encodeURIComponent(u)}`),p!=="all"&&(a+=`&parkId=${p}`),g!=="all"&&(a+=`&healthStatus=${g}`),j!=="all"&&(a+=`&speciesId=${j}`);const i=await fetch(a);if(!i.ok)throw new Error("Error al cargar el inventario de árboles");return i.json()},suspense:!1,retry:1});q.useEffect(()=>{J&&l({title:"Error",description:"No se pudo cargar el inventario de árboles. Por favor, intenta nuevamente.",variant:"destructive"})},[J,l]);const G=()=>{K("/admin/trees/inventory/new")};te({mutationFn:async()=>je("/api/trees/delete-all",{method:"DELETE"}),onSuccess:a=>{l({title:"Inventario limpiado",description:a.message||"Todos los árboles han sido eliminados del inventario"}),Q.invalidateQueries({queryKey:["/api/trees"]})},onError:a=>{l({title:"Error al limpiar inventario",description:a.message||"No se pudieron eliminar todos los árboles",variant:"destructive"})}});const ke=async()=>{try{let a="/api/trees/export-csv?";const i=new URLSearchParams;u&&i.append("search",u),p!=="all"&&i.append("parkId",p),g!=="all"&&i.append("healthStatus",g),j!=="all"&&i.append("speciesId",j),a+=i.toString();const b=await fetch(a,{headers:{Authorization:`Bearer ${localStorage.getItem("directToken")}`}});if(!b.ok)throw new Error("Error al exportar CSV");const C=await b.blob(),c=window.URL.createObjectURL(C),m=document.createElement("a");m.href=c;const S=new Date().toLocaleDateString("es-ES").replace(/\//g,"-");m.download=`inventario_arboles_${S}.csv`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(c),l({title:"Exportación exitosa",description:"El archivo CSV ha sido descargado correctamente"})}catch{l({title:"Error al exportar",description:"No se pudo exportar el archivo CSV",variant:"destructive"})}},Pe=()=>{const a=["codigo","especie_id","parque_id","latitud","longitud","fecha_plantacion","etapa_desarrollo","edad_estimada","altura","diametro","cobertura_copa","estado_salud","descripcion_ubicacion","notas"],i=[["AHU-BOS-001","1","5","20.6597","-103.3496","2020-03-15","adulto","5","8.5","45","6.2","Bueno","Entrada principal del parque","Árbol emblemático en buen estado"],["JAC-PAR-002","2","7","20.6612","-103.3510","2019-11-20","juvenil","3","5.2","25","3.8","Regular","Área de juegos infantiles","Requiere poda de mantenimiento"]],b=[a.join(","),...i.map(m=>m.join(","))].join(`
`),C=new Blob(["\uFEFF"+b],{type:"text/csv;charset=utf-8;"}),c=document.createElement("a");c.href=URL.createObjectURL(C),c.download="plantilla_inventario_arboles.csv",c.click(),URL.revokeObjectURL(c.href)},qe=a=>{var C;const i=(C=a.target.files)==null?void 0:C[0];if(!i)return;const b=new FileReader;b.onload=c=>{var ie;const S=((ie=c.target)==null?void 0:ie.result).split(`
`).filter(f=>f.trim());if(S.length<2){l({title:"Error en el archivo",description:"El archivo CSV debe tener al menos una fila de datos",variant:"destructive"});return}const se=S[0].split(",").map(f=>f.trim().replace(/"/g,"")),re=["codigo","especie_id","parque_id","estado_salud"].filter(f=>!se.includes(f));if(re.length>0){l({title:"Error en formato CSV",description:`Faltan columnas requeridas: ${re.join(", ")}`,variant:"destructive"});return}const Fe=S.slice(1,6).map(f=>{const Re=f.split(",").map(B=>B.trim().replace(/"/g,"")),ne={};return se.forEach((B,Ae)=>{ne[B]=Re[Ae]||""}),ne});I(Fe),P(!0)},b.readAsText(i)},_=te({mutationFn:async a=>je("/api/trees/import-csv",{method:"POST",data:{trees:a}}),onSuccess:a=>{l({title:"Importación exitosa",description:a.message||"Los árboles han sido importados correctamente"}),Q.invalidateQueries({queryKey:["/api/trees"]}),P(!1),I([]),y.current&&(y.current.value="")},onError:a=>{l({title:"Error al importar",description:a.message||"No se pudieron importar los árboles",variant:"destructive"})}}),De=()=>{_.mutate(w)},W=a=>{K(`/admin/trees/inventory/${a}`)},v=a=>{T(a)},Le=a=>{a.preventDefault(),T(1)};q.useEffect(()=>{T(1)},[u,p,g,j]);const Te=a=>{switch(a.toLowerCase()){case"bueno":return e.jsxs(k,{variant:"outline",className:"bg-green-50 text-green-700 hover:bg-green-100",children:[e.jsx(oa,{className:"h-3 w-3 mr-1"})," Bueno"]});case"regular":return e.jsxs(k,{variant:"outline",className:"bg-yellow-50 text-yellow-700 hover:bg-yellow-100",children:[e.jsx(ia,{className:"h-3 w-3 mr-1"})," Regular"]});case"malo":return e.jsxs(k,{variant:"outline",className:"bg-orange-50 text-orange-700 hover:bg-orange-100",children:[e.jsx(ve,{className:"h-3 w-3 mr-1"})," Malo"]});case"crítico":return e.jsxs(k,{variant:"destructive",children:[e.jsx(ve,{className:"h-3 w-3 mr-1"})," Crítico"]});default:return e.jsx(k,{variant:"outline",children:a})}},Ie=a=>{if(!a)return"No disponible";try{return na(new Date(a),"dd/MM/yyyy",{locale:ta})}catch{return"Fecha inválida"}},V=s&&s.data&&s.data.length>0,o=((Y=s==null?void 0:s.pagination)==null?void 0:Y.totalPages)||1,X=((Z=s==null?void 0:s.pagination)==null?void 0:Z.total)||0;return q.useEffect(()=>{var a;s&&console.log("Tree inventory response:",{hasData:V,dataLength:(a=s.data)==null?void 0:a.length,totalPages:o,totalRecords:X,currentPage:r,pagination:s.pagination})},[s,V,o,X,r]),e.jsxs(Ue,{children:[e.jsxs(la,{children:[e.jsx("title",{children:"Inventario de Árboles | Bosques Urbanos"}),e.jsx("meta",{name:"description",content:"Gestión del inventario de árboles en los parques municipales"})]}),e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsx(M,{className:"p-4 bg-gray-50 mb-6",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"w-8 h-8 text-gray-900"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Inventario de Árboles"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Gestión y seguimiento de árboles individuales en los parques"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{onClick:ke,variant:"outline",className:"border-green-600 text-green-600 hover:bg-green-50",children:[e.jsx(oe,{className:"mr-2 h-4 w-4"})," Exportar CSV"]}),e.jsxs(Me,{open:Ce,onOpenChange:P,children:[e.jsx(He,{asChild:!0,children:e.jsxs(d,{variant:"outline",className:"border-blue-600 text-blue-600 hover:bg-blue-50",onClick:()=>{var a;return(a=y.current)==null?void 0:a.click()},children:[e.jsx($e,{className:"mr-2 h-4 w-4"})," Importar CSV"]})}),e.jsxs(Oe,{className:"max-w-4xl",children:[e.jsxs(ze,{children:[e.jsx(Ke,{children:"Importar Árboles desde CSV"}),e.jsx(Qe,{children:w.length>0?"Vista previa de los primeros 5 registros. Confirma para importar todos los datos.":"Selecciona un archivo CSV para importar árboles o descarga la plantilla para ver el formato requerido."})]}),w.length===0&&e.jsxs("div",{className:"flex flex-col space-y-4 p-4 border-2 border-dashed border-gray-300 rounded-lg",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"¿Primera vez importando árboles? Descarga la plantilla con ejemplos para ver el formato correcto."}),e.jsxs(d,{onClick:Pe,variant:"outline",className:"border-green-600 text-green-600 hover:bg-green-50",children:[e.jsx(oe,{className:"mr-2 h-4 w-4"})," Descargar Plantilla CSV"]})]}),e.jsx("div",{className:"text-center text-sm text-gray-500",children:"La plantilla incluye todas las columnas disponibles y dos ejemplos (Ahuehuete y Jacaranda)"})]}),w.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(D,{children:[e.jsx(n,{children:"Código"}),e.jsx(n,{children:"Especie ID"}),e.jsx(n,{children:"Parque ID"}),e.jsx(n,{children:"Estado Salud"}),e.jsx(n,{children:"Altura"}),e.jsx(n,{children:"Ubicación"})]})}),e.jsx(he,{children:w.map((a,i)=>e.jsxs(D,{children:[e.jsx(t,{children:a.codigo||"N/A"}),e.jsx(t,{children:a.especie_id||"N/A"}),e.jsx(t,{children:a.parque_id||"N/A"}),e.jsx(t,{children:a.estado_salud||"N/A"}),e.jsx(t,{children:a.altura||"N/A"}),e.jsx(t,{children:a.descripcion_ubicacion||"N/A"})]},i))})]})}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{P(!1),I([]),y.current&&(y.current.value="")},children:"Cancelar"}),e.jsx(d,{onClick:De,disabled:_.isPending,className:"bg-blue-600 hover:bg-blue-700",children:_.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Je,{className:"mr-2 h-4 w-4 animate-spin"}),"Importando..."]}):"Confirmar Importación"})]})]})]})]}),e.jsxs(d,{onClick:G,className:"bg-green-600 hover:bg-green-700 flex items-center",children:[e.jsx(xe,{className:"mr-2 h-4 w-4"})," Agregar Árbol"]})]}),e.jsx("input",{ref:y,type:"file",accept:".csv",onChange:qe,style:{display:"none"}})]})}),e.jsxs(M,{className:"mb-6",children:[e.jsxs(me,{className:"pb-3",children:[e.jsx(ue,{children:"Filtros de Búsqueda"}),e.jsx(Ge,{children:"Utiliza los filtros para encontrar árboles específicos"})]}),e.jsx(pe,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("form",{onSubmit:Le,className:"md:col-span-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(We,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"}),e.jsx(Xe,{type:"search",placeholder:"Buscar por código o descripción...",className:"pl-9",value:u,onChange:a=>be(a.target.value)})]})}),e.jsx("div",{children:e.jsxs(H,{value:p,onValueChange:fe,children:[e.jsx($,{children:e.jsx(O,{placeholder:"Filtrar por parque"})}),e.jsxs(z,{children:[e.jsx(h,{value:"all",children:"Todos los parques"}),!we&&(R==null?void 0:R.map(a=>e.jsx(h,{value:a.id.toString(),children:a.name},a.id)))]})]})}),e.jsx("div",{children:e.jsxs(H,{value:j,onValueChange:ye,children:[e.jsx($,{children:e.jsx(O,{placeholder:"Filtrar por especie"})}),e.jsxs(z,{children:[e.jsx(h,{value:"all",children:"Todas las especies"}),!Se&&((ee=A==null?void 0:A.data)==null?void 0:ee.map(a=>e.jsx(h,{value:a.id.toString(),children:a.commonName},a.id)))]})]})}),e.jsx("div",{children:e.jsxs(H,{value:g,onValueChange:Ne,children:[e.jsx($,{children:e.jsx(O,{placeholder:"Filtrar por estado"})}),e.jsxs(z,{children:[e.jsx(h,{value:"all",children:"Todos los estados"}),e.jsx(h,{value:"Bueno",children:"Bueno"}),e.jsx(h,{value:"Regular",children:"Regular"}),e.jsx(h,{value:"Malo",children:"Malo"}),e.jsx(h,{value:"Crítico",children:"Crítico"})]})]})})]})})]}),e.jsxs(M,{children:[e.jsx(me,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(ue,{children:"Listado de Árboles"}),e.jsx("div",{className:"flex items-center gap-3",children:s&&e.jsx("div",{className:"text-sm text-gray-500",children:s.pagination?e.jsxs(e.Fragment,{children:["Página ",s.pagination.page," de ",s.pagination.totalPages," - Mostrando ",(s.pagination.page-1)*10+1,"-",Math.min(s.pagination.page*10,s.pagination.total)," de ",s.pagination.total," árboles"]}):e.jsxs(e.Fragment,{children:["Total: ",s.total||((ae=s.data)==null?void 0:ae.length)||0," árboles"]})})})]})}),e.jsx(pe,{children:Ee?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(L,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{className:"h-4 w-[250px]"}),e.jsx(L,{className:"h-4 w-[200px]"})]})]}),e.jsx(L,{className:"h-[400px] w-full"})]}):V?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(D,{children:[e.jsx(n,{className:"w-[80px]",children:"Código"}),e.jsx(n,{children:"Especie"}),e.jsx(n,{children:"Parque"}),e.jsx(n,{children:"Estado"}),e.jsx(n,{children:"Altura (m)"}),e.jsx(n,{children:"DAP (cm)"}),e.jsx(n,{children:"Última Inspección"}),e.jsx(n,{children:"Acciones"})]})}),e.jsx(he,{children:s.data.map(a=>e.jsxs(D,{className:"cursor-pointer hover:bg-gray-50",onClick:()=>W(a.id),children:[e.jsx(t,{className:"font-medium",children:a.code}),e.jsxs(t,{children:[e.jsx("div",{className:"font-medium",children:a.speciesName}),e.jsx("div",{className:"text-sm text-gray-500 italic",children:a.scientificName})]}),e.jsx(t,{children:a.parkName}),e.jsx(t,{children:Te(a.healthStatus)}),e.jsx(t,{children:a.height?`${a.height} m`:"-"}),e.jsx(t,{children:a.diameter?`${a.diameter} cm`:"-"}),e.jsx(t,{children:Ie(a.lastInspectionDate)}),e.jsx(t,{children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(d,{variant:"ghost",size:"sm",onClick:i=>{i.stopPropagation(),W(a.id)},className:"text-green-600 hover:text-green-800 hover:bg-green-50",children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"})," Ver"]}),e.jsxs(d,{variant:"ghost",size:"sm",onClick:i=>{i.stopPropagation(),window.open(`https://www.google.com/maps/search/?api=1&query=${a.latitude},${a.longitude}`,"_blank")},className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50",children:[e.jsx(Ze,{className:"h-4 w-4 mr-1"})," Mapa"]})]})})]},a.id))})]})}),o>1&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(ea,{children:e.jsxs(aa,{children:[e.jsx(x,{children:e.jsx(sa,{onClick:()=>v(Math.max(1,r-1)),disabled:r===1})}),r>2&&e.jsx(x,{children:e.jsx(E,{onClick:()=>v(1),children:"1"})}),r>3&&e.jsx(x,{children:e.jsx(ge,{})}),r>1&&e.jsx(x,{children:e.jsx(E,{onClick:()=>v(r-1),children:r-1})}),e.jsx(x,{children:e.jsx(E,{isActive:!0,onClick:()=>v(r),children:r})}),r<o&&e.jsx(x,{children:e.jsx(E,{onClick:()=>v(r+1),children:r+1})}),r<o-2&&e.jsx(x,{children:e.jsx(ge,{})}),r<o-1&&e.jsx(x,{children:e.jsx(E,{onClick:()=>v(o),children:o})}),e.jsx(x,{children:e.jsx(ra,{onClick:()=>v(Math.min(o,r+1)),disabled:r===o})})]})})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(le,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No se encontraron árboles"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"No hay árboles registrados que coincidan con los criterios de búsqueda. Prueba a cambiar los filtros o agrega un nuevo árbol al inventario."}),e.jsxs(d,{onClick:G,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(xe,{className:"mr-2 h-4 w-4"})," Agregar Árbol"]})]})})]})]})]})}export{ua as default};
