import{Y as t,e as me,a6 as he,u as E,a8 as ue,j as e,aB as je,B as u,C as j,a as p,b as g,aE as U,c as f,au as V,h as pe,aj as ge,a3 as Q,y as l,Z as ee,I as G,z as y,H as w,J as C,K as S,N as a,M as se,f as J,ba as fe,bb as ve,bc as ae,bd as v,be as Ne,bf as N,ax as be,l as ye,D as we,r as Ce,t as Se,v as Te,w as Me,O as De,b7 as Fe,X as Be}from"./index-BBGHPKhn.js";import{S as ne}from"./skeleton-DR_YLL_-.js";import{C as te}from"./circle-plus-DoRp-yQT.js";import{R as Ie}from"./refresh-cw-DS5oknip.js";function qe(){const[b,k]=t.useState(""),[T,W]=t.useState("all"),[M,_]=t.useState("all"),[D,X]=t.useState("all"),[F,le]=t.useState("all"),[re,R]=t.useState(!1),[Y,P]=t.useState(null),[c,q]=t.useState(null),[r,B]=t.useState({maintenanceType:"",notes:"",performedBy:""}),{toast:z}=me(),ie=he(),{data:L}=E({queryKey:["/api/parks"],select:s=>s.data}),{data:H}=E({queryKey:["/api/tree-species"],select:s=>s.data}),{data:d,isLoading:ce}=E({queryKey:["/api/trees/inventory-all"],queryFn:async()=>{const s=await fetch("/api/trees/inventory?limit=1000");if(!s.ok)throw new Error("Error al cargar árboles");return(await s.json()).data||[]}}),o=t.useMemo(()=>{if(!d)return[];let s=[...d];if(b.trim()){const n=b.toLowerCase();s=s.filter(x=>{var m,I,h;return((m=x.code)==null?void 0:m.toLowerCase().includes(n))||((I=x.speciesName)==null?void 0:I.toLowerCase().includes(n))||((h=x.parkName)==null?void 0:h.toLowerCase().includes(n))})}return T!=="all"&&(s=s.filter(n=>n.parkId===parseInt(T))),M!=="all"&&(s=s.filter(n=>n.speciesId===parseInt(M))),D!=="all"&&(s=s.filter(n=>n.healthStatus===D)),s.slice(0,50)},[d,b,T,M,D]),{data:i,isLoading:de}=E({queryKey:["/api/trees/maintenances"],select:s=>(s==null?void 0:s.data)||[]}),O=t.useMemo(()=>{if(!i)return[];let s=[...i];return F!=="all"&&(s=s.filter(n=>n.maintenanceType===F)),s},[i,F]),A=t.useMemo(()=>{if(!i||!d)return{total:0,coverage:0,recent:0};const s=i.length,n=new Set(i.map(h=>h.treeId)).size,x=d.length>0?Math.round(n/d.length*100):0,m=new Date;m.setDate(m.getDate()-30);const I=i.filter(h=>new Date(h.maintenanceDate)>=m).length;return{total:s,coverage:x,recent:I}},[i,d]),K=ue({mutationFn:async s=>{const n=await fetch(`/api/trees/${Y}/maintenances`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!n.ok){const x=await n.json();throw new Error(x.message||"Error al registrar mantenimiento")}return n.json()},onSuccess:()=>{ie.invalidateQueries({queryKey:["/api/trees/maintenances"]}),z({title:"Mantenimiento registrado",description:"El registro se ha guardado correctamente"}),$()},onError:s=>{z({title:"Error",description:s.message,variant:"destructive"})}}),Z=s=>{P(s.id),q(s)},$=()=>{R(!1),P(null),q(null),B({maintenanceType:"",notes:"",performedBy:""})},oe=()=>{if(!Y||!r.maintenanceType||!r.performedBy){z({title:"Campos requeridos",description:"Completa todos los campos obligatorios",variant:"destructive"});return}K.mutate({...r,maintenanceDate:new Date().toISOString().split("T")[0]})},xe=()=>{k(""),W("all"),_("all"),X("all")};return e.jsxs(je,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Mantenimiento de Árboles"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Sistema escalable para gestión de mantenimiento con inventarios grandes"})]}),e.jsxs(u,{onClick:()=>R(!0),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Nuevo Mantenimiento"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(j,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(g,{className:"text-sm font-medium",children:"Mantenimientos Totales"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(f,{children:e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:A.total})})]}),e.jsxs(j,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(g,{className:"text-sm font-medium",children:"Cobertura de Árboles"}),e.jsx(V,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(f,{children:e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[A.coverage,"%"]})})]}),e.jsxs(j,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(g,{className:"text-sm font-medium",children:"Recientes (30 días)"}),e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(f,{children:e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:A.recent})})]})]}),e.jsxs(j,{children:[e.jsxs(p,{children:[e.jsxs(g,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5"}),"Filtros de Búsqueda de Árboles"]}),e.jsx(Q,{children:"Filtra y busca árboles específicos antes de registrar mantenimiento"})]}),e.jsxs(f,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx(l,{htmlFor:"search",children:"Buscar árbol"}),e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(G,{id:"search",placeholder:"Código, especie o ubicación...",className:"pl-8",value:b,onChange:s=>k(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Parque"}),e.jsxs(y,{value:T,onValueChange:W,children:[e.jsx(w,{children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(a,{value:"all",children:"Todos los parques"}),L==null?void 0:L.map(s=>e.jsx(a,{value:s.id.toString(),children:s.name},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Especie"}),e.jsxs(y,{value:M,onValueChange:_,children:[e.jsx(w,{children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(a,{value:"all",children:"Todas las especies"}),H==null?void 0:H.map(s=>e.jsx(a,{value:s.id.toString(),children:s.commonName},s.id))]})]})]}),e.jsxs("div",{children:[e.jsx(l,{children:"Estado de Salud"}),e.jsxs(y,{value:D,onValueChange:X,children:[e.jsx(w,{children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(a,{value:"all",children:"Todos los estados"}),e.jsx(a,{value:"Excelente",children:"Excelente"}),e.jsx(a,{value:"Bueno",children:"Bueno"}),e.jsx(a,{value:"Regular",children:"Regular"}),e.jsx(a,{value:"Malo",children:"Malo"}),e.jsx(a,{value:"Crítico",children:"Crítico"})]})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsxs(u,{variant:"outline",size:"sm",onClick:xe,children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Limpiar Filtros"]}),e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center",children:["Mostrando ",o.length," árbol(es) ",o.length===50?"(limitado a 50)":""]})]})]})]}),e.jsxs(j,{children:[e.jsxs(p,{children:[e.jsx(g,{children:"Árboles Encontrados"}),e.jsx(Q,{children:"Selecciona un árbol para registrar mantenimiento"})]}),e.jsx(f,{children:ce?e.jsx("div",{className:"space-y-2",children:[...Array(5)].map((s,n)=>e.jsx(ne,{className:"h-16 w-full"},n))}):o.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(V,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-medium",children:"No se encontraron árboles"}),e.jsx("p",{className:"text-muted-foreground",children:"Ajusta los filtros para encontrar árboles específicos"})]}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:o.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-accent cursor-pointer transition-colors",onClick:()=>Z(s),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.code}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.speciesName})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:s.parkName})]}),e.jsx(J,{variant:s.healthStatus==="Excelente"?"default":s.healthStatus==="Bueno"?"secondary":s.healthStatus==="Regular"?"outline":"destructive",children:s.healthStatus})]}),e.jsxs(u,{size:"sm",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Registrar Mantenimiento"]})]},s.id))})})]}),e.jsxs(j,{children:[e.jsxs(p,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(g,{children:"Historial de Mantenimientos"}),e.jsxs(Q,{children:[O.length," registro(s) de mantenimiento"]})]}),e.jsxs(y,{value:F,onValueChange:le,children:[e.jsx(w,{className:"w-[200px]",children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(a,{value:"all",children:"Todos los tipos"}),e.jsx(a,{value:"Poda",children:"Poda"}),e.jsx(a,{value:"Riego",children:"Riego"}),e.jsx(a,{value:"Fertilización",children:"Fertilización"}),e.jsx(a,{value:"Control de plagas",children:"Control de plagas"}),e.jsx(a,{value:"Tratamiento de enfermedades",children:"Tratamiento de enfermedades"}),e.jsx(a,{value:"Inspección",children:"Inspección"})]})]})]}),e.jsx(f,{children:de?e.jsx("div",{className:"space-y-2",children:[...Array(5)].map((s,n)=>e.jsx(ne,{className:"h-12 w-full"},n))}):O.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(U,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-medium",children:"No hay registros"}),e.jsx("p",{className:"text-muted-foreground",children:"No se encontraron mantenimientos con los filtros aplicados"})]}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(fe,{children:[e.jsx(ve,{children:e.jsxs(ae,{children:[e.jsx(v,{children:"Código Árbol"}),e.jsx(v,{children:"Parque"}),e.jsx(v,{children:"Especie"}),e.jsx(v,{children:"Tipo"}),e.jsx(v,{children:"Fecha"}),e.jsx(v,{children:"Responsable"})]})}),e.jsx(Ne,{children:O.map(s=>e.jsxs(ae,{children:[e.jsx(N,{className:"font-medium",children:s.treeCode}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3 w-3 text-muted-foreground"}),s.parkName]})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(be,{className:"h-3 w-3 text-green-600"}),s.speciesName]})}),e.jsx(N,{children:e.jsx(J,{variant:"outline",className:"bg-green-50 text-green-700",children:s.maintenanceType})}),e.jsx(N,{children:ye(new Date(s.maintenanceDate),"dd/MM/yyyy",{locale:Be})}),e.jsx(N,{children:s.performedBy})]},s.id))})]})})})]})]}),e.jsx(we,{open:re,onOpenChange:R,children:e.jsxs(Ce,{className:"sm:max-w-[700px]",children:[e.jsxs(Se,{children:[e.jsx(Te,{children:"Registrar Mantenimiento"}),e.jsx(Me,{children:c?e.jsxs("div",{className:"mt-2 p-3 bg-accent rounded-lg",children:[e.jsx("div",{className:"font-medium",children:c.code}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[c.speciesName," - ",c.parkName]})]}):"Selecciona un árbol para registrar mantenimiento"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[!c&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Buscar Árbol"}),e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(G,{placeholder:"Código, especie o parque...",className:"pl-8",value:b,onChange:s=>k(s.target.value)})]})]}),o.length>0&&e.jsxs("div",{className:"border rounded-lg max-h-48 overflow-y-auto",children:[e.jsxs("div",{className:"text-xs text-muted-foreground p-2 border-b",children:[o.length," árbol(es) encontrado(s)"]}),o.slice(0,10).map(s=>e.jsx("div",{className:"p-2 hover:bg-accent cursor-pointer border-b last:border-b-0",onClick:()=>Z(s),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.code}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.speciesName," • ",s.parkName]})]}),e.jsx(J,{variant:"outline",className:"text-xs",children:s.healthStatus})]})},s.id))]})]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(l,{className:"text-base font-medium",children:"Árbol Seleccionado"}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>{q(null),P(null)},children:"Cambiar Árbol"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{htmlFor:"maintenanceType",children:"Tipo de Mantenimiento *"}),e.jsxs(y,{onValueChange:s=>B({...r,maintenanceType:s}),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Selecciona un tipo"})}),e.jsxs(S,{children:[e.jsx(a,{value:"Poda",children:"Poda"}),e.jsx(a,{value:"Riego",children:"Riego"}),e.jsx(a,{value:"Fertilización",children:"Fertilización"}),e.jsx(a,{value:"Control de plagas",children:"Control de plagas"}),e.jsx(a,{value:"Tratamiento de enfermedades",children:"Tratamiento de enfermedades"}),e.jsx(a,{value:"Inspección",children:"Inspección"}),e.jsx(a,{value:"Otro",children:"Otro"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{htmlFor:"performedBy",children:"Realizado por *"}),e.jsx(G,{id:"performedBy",placeholder:"Nombre del responsable",value:r.performedBy,onChange:s=>B({...r,performedBy:s.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{htmlFor:"notes",children:"Notas del Mantenimiento"}),e.jsx(De,{id:"notes",placeholder:"Detalles del mantenimiento realizado...",rows:3,value:r.notes,onChange:s=>B({...r,notes:s.target.value})})]})]})]}),e.jsxs(Fe,{children:[e.jsx(u,{variant:"outline",onClick:$,children:"Cancelar"}),c&&e.jsx(u,{onClick:oe,disabled:K.isPending,children:K.isPending?"Guardando...":"Guardar Mantenimiento"})]})]})})]})}export{qe as default};
