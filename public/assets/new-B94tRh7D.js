import{ce as U,cf as m,cg as K,az as O,ae as Q,a2 as P,af as z,u as C,ag as G,R as S,j as e,aX as W,B as w,A as X,f as _,g as H,h as Y,aW as q,i as J,ai as Z,aj as t,ak as o,al as c,am as l,O as p,an as d,Q as h,V as j,W as g,Y as b,_ as x,$ as ee,N as ae,bX as se,bG as ne,ap as ie,aq as re,cb as A}from"./index-D5qLf1ib.js";const te=U({title:m().min(1,"El título es obligatorio"),description:m().min(10,"La descripción debe tener al menos 10 caracteres"),priority:K(["low","medium","high","critical"]),categoryId:m().min(1,"La categoría es obligatoria"),assetId:m().optional(),parkId:m().min(1,"El parque es obligatorio"),location:m().optional(),reportedBy:m().min(1,"El responsable del reporte es obligatorio"),contactInfo:m().optional()}),de=()=>{var F,V;const[oe,f]=O(),L=Q(),[T,k]=P.useState(new Date),n=new URLSearchParams(window.location.search).get("assetId"),i=z({resolver:ie(te),defaultValues:{title:"",description:"",priority:"medium",categoryId:"",assetId:n||"",parkId:"",location:"",reportedBy:"",contactInfo:""}}),{data:v=[]}=C({queryKey:["/api/parks"],retry:!1}),{data:I=[]}=C({queryKey:["/api/assets"],retry:!1}),{data:y=[]}=C({queryKey:["/api/incident-categories"],retry:!1}),N=G({mutationFn:async a=>{const s={title:a.title,description:a.description,assetId:a.assetId&&a.assetId!=="none"?parseInt(a.assetId):null,parkId:parseInt(a.parkId),categoryId:parseInt(a.categoryId),severity:a.priority,location:a.location,reporterName:a.reportedBy,reporterEmail:a.contactInfo,status:"pending"};return console.log("📝 Datos del formulario a enviar:",a),console.log("📝 Datos procesados para envío:",s),re("/api/incidents",{method:"POST",data:s})},onSuccess:()=>{A({title:"Incidencia creada",description:"La incidencia ha sido reportada exitosamente."}),L.invalidateQueries({queryKey:["/api/incidents"]}),f("/admin/incidents")},onError:a=>{A({title:"Error",description:a.message||"No se pudo crear la incidencia.",variant:"destructive"})}}),$=a=>{N.mutate(a)},M=[{id:1,name:"Mantenimiento",description:"Problemas de mantenimiento general"},{id:2,name:"Seguridad",description:"Incidentes de seguridad"},{id:3,name:"Limpieza",description:"Problemas de limpieza"},{id:4,name:"Infraestructura",description:"Daños en infraestructura"},{id:5,name:"Vandalismo",description:"Actos de vandalismo"}],R=S.useMemo(()=>(y.length>0?y:M).filter(s=>s&&s.id&&s.name&&s.name.trim()!==""&&s.id.toString().trim()!==""),[y]),D=S.useMemo(()=>Array.isArray(v)?v.filter(a=>a&&a.id&&a.name&&a.name.trim()!==""&&a.id.toString().trim()!==""):[],[v]),u=S.useMemo(()=>Array.isArray(I)?I.filter(a=>a&&a.id&&a.name&&a.name.trim()!==""&&a.id.toString().trim()!==""):[],[I]),B=R;return P.useEffect(()=>{var a;if(n&&u.length>0){const s=u.find(r=>r.id===parseInt(n));if(s){i.setValue("assetId",n),i.setValue("parkId",((a=s.parkId)==null?void 0:a.toString())||"");let r="";if(s.locationDescription&&s.locationDescription.trim()&&(r=s.locationDescription.trim()),s.latitude&&s.longitude){const E=`${parseFloat(s.latitude).toFixed(6)}, ${parseFloat(s.longitude).toFixed(6)}`;r=r?`${r} (Coordenadas: ${E})`:`Coordenadas: ${E}`}r||(r=`Área del activo: ${s.name}`),i.setValue("location",r),console.log("🎯 Datos del activo cargados automáticamente:",{assetId:s.id,assetName:s.name,parkId:s.parkId,location:r,coordinates:s.latitude&&s.longitude?`${s.latitude}, ${s.longitude}`:"No disponibles"})}}},[n,u,i]),e.jsx(W,{children:e.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[e.jsx("div",{className:"flex items-center gap-4 mb-6",children:e.jsxs(w,{variant:"ghost",onClick:()=>f("/admin/incidents"),className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),"Volver a Incidencias"]})}),e.jsxs(_,{children:[e.jsx(H,{children:e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5 text-orange-500"}),"Reportar Nueva Incidencia"]})}),e.jsxs(J,{children:[n&&e.jsx("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-1 bg-blue-100 rounded",children:e.jsx(q,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-1",children:"Formulario configurado automáticamente"}),e.jsx("p",{className:"text-sm text-blue-700 mb-2",children:"Los campos de activo, parque y ubicación se han completado automáticamente basándose en el activo seleccionado desde el inventario."}),e.jsxs("div",{className:"text-xs text-blue-600 space-y-1",children:[e.jsxs("div",{children:["• ",e.jsx("strong",{children:"Activo:"})," ",((F=u.find(a=>a.id===parseInt(n)))==null?void 0:F.name)||"Cargando..."]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"Parque:"})," ",((V=D.find(a=>a.id===parseInt(i.watch("parkId"))))==null?void 0:V.name)||"Cargando..."]}),e.jsxs("div",{children:["• ",e.jsx("strong",{children:"Ubicación:"})," Incluye coordenadas precisas del activo"]})]})]})]})}),e.jsx(Z,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit($),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:i.control,name:"title",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Título de la Incidencia"}),e.jsx(l,{children:e.jsx(p,{placeholder:"Ej: Daño en resbaladilla",...a})}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"priority",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Prioridad"}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(l,{children:e.jsx(j,{children:e.jsx(g,{placeholder:"Seleccionar prioridad"})})}),e.jsxs(b,{children:[e.jsx(x,{value:"low",children:"Baja"}),e.jsx(x,{value:"medium",children:"Media"}),e.jsx(x,{value:"high",children:"Alta"}),e.jsx(x,{value:"critical",children:"Crítica"})]})]}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"categoryId",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Categoría"}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,children:[e.jsx(l,{children:e.jsx(j,{children:e.jsx(g,{placeholder:"Seleccionar categoría"})})}),e.jsx(b,{children:B.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))})]}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"parkId",render:({field:a})=>e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:["Parque",n&&e.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded",children:"Cargado automáticamente"})]}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,disabled:!!n,children:[e.jsx(l,{children:e.jsx(j,{className:n?"bg-gray-50 cursor-not-allowed":"",children:e.jsx(g,{placeholder:"Seleccionar parque"})})}),e.jsx(b,{children:D.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))})]}),n&&e.jsx("p",{className:"text-xs text-gray-600",children:"El parque se cargó automáticamente desde el activo seleccionado"}),e.jsx(d,{})]})}),u.length>0&&e.jsx(t,{control:i.control,name:"assetId",render:({field:a})=>e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:["Activo Relacionado ",n?"":"(Opcional)",n&&e.jsx("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded",children:"Preseleccionado"})]}),e.jsxs(h,{onValueChange:a.onChange,defaultValue:a.value,disabled:!!n,children:[e.jsx(l,{children:e.jsx(j,{className:n?"bg-gray-50 cursor-not-allowed":"",children:e.jsx(g,{placeholder:"Seleccionar activo"})})}),e.jsxs(b,{children:[e.jsx(x,{value:"none",children:"Sin activo específico"}),u.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))]})]}),n&&e.jsx("p",{className:"text-xs text-gray-600",children:"El activo fue preseleccionado desde el inventario de activos"}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"location",render:({field:a})=>e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2",children:["Ubicación Específica",n&&e.jsx("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded",children:"Incluye coordenadas"})]}),e.jsx(l,{children:e.jsx(p,{placeholder:"Ej: Área de juegos infantiles",...a,readOnly:!!n,className:n?"bg-gray-50 cursor-not-allowed":""})}),n&&e.jsx("p",{className:"text-xs text-gray-600",children:"La ubicación se cargó automáticamente del activo con coordenadas precisas"}),e.jsx(d,{})]})})]}),e.jsx(t,{control:i.control,name:"description",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Descripción Detallada"}),e.jsx(l,{children:e.jsx(ee,{placeholder:"Describe la incidencia con el mayor detalle posible...",className:"min-h-[100px]",...a})}),e.jsx(d,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(t,{control:i.control,name:"reportedBy",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Reportado Por"}),e.jsx(l,{children:e.jsx(p,{placeholder:"Nombre del responsable",...a})}),e.jsx(d,{})]})}),e.jsx(t,{control:i.control,name:"contactInfo",render:({field:a})=>e.jsxs(o,{children:[e.jsx(c,{children:"Información de Contacto"}),e.jsx(l,{children:e.jsx(p,{placeholder:"Email o teléfono",...a})}),e.jsx(d,{})]})})]}),e.jsxs("div",{children:[e.jsx(ae,{children:"Fecha de la Incidencia"}),e.jsx("div",{className:"mt-2",children:e.jsx(se,{mode:"single",selected:T,onSelect:a=>a&&k(a),className:"rounded-md border w-fit"})})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(w,{type:"button",variant:"outline",onClick:()=>f("/admin/incidents"),children:"Cancelar"}),e.jsxs(w,{type:"submit",disabled:N.isPending,className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),N.isPending?"Guardando...":"Crear Incidencia"]})]})]})})]})]})]})})};export{de as default};
