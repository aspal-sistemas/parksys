import{aC as Ae,az as Fe,ae as qe,a2 as t,j as e,aX as Le,B,A as $e,f as Me,g as Te,h as Re,i as Pe,N as n,O as g,$ as pe,Q as C,V as y,W as I,Y as k,_ as d,M as ge,bG as Ve}from"./index-D5qLf1ib.js";import{M as Oe,T as ze,L as xe,a as Ue}from"./leaflet-CDEiJxZW.js";import{u as Be}from"./hooks-ByDnCwIh.js";delete xe.Icon.Default.prototype._getIconUrl;xe.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});function Ge({position:x,setPosition:N}){return Be({click(b){N([b.latlng.lat,b.latlng.lng])}}),x===null?null:e.jsx(Ue,{position:x})}function _e(){const[,x]=Ae("/admin/assets/:id/edit-enhanced"),[,N]=Fe(),b=qe(),[G,Q]=t.useState(!1),[H,u]=t.useState(""),[K,_]=t.useState(""),l=x==null?void 0:x.id,[E,J]=t.useState(""),[W,X]=t.useState(""),[Y,Z]=t.useState(""),[ee,ae]=t.useState(""),[A,se]=t.useState(""),[te,ie]=t.useState("activo"),[ne,re]=t.useState("bueno"),[o,le]=t.useState(""),[F,oe]=t.useState(""),[ce,j]=t.useState(""),[de,q]=t.useState(""),[v,S]=t.useState(""),[L,$]=t.useState(""),[M,T]=t.useState(""),[je,R]=t.useState(null),[P,V]=t.useState([19.432608,-99.133209]),[h,ve]=t.useState([]),[ue,fe]=t.useState([]),[he,O]=t.useState([]),Ne=[{value:"activo",label:"Activo"},{value:"maintenance",label:"En Mantenimiento"},{value:"retired",label:"Retirado"},{value:"storage",label:"En Almacén"}],be=[{value:"excelente",label:"Excelente"},{value:"bueno",label:"Bueno"},{value:"regular",label:"Regular"},{value:"malo",label:"Malo"},{value:"critico",label:"Crítico"}];t.useEffect(()=>{if(!l)return;(async()=>{try{const[i,c,f]=await Promise.all([fetch(`/api/assets/${l}`),fetch("/api/parks"),fetch("/api/asset-categories")]),s=await i.json(),we=await c.json(),De=await f.json();J(s.name||""),X(s.description||""),Z(s.serialNumber||""),ae(s.notes||""),se(s.acquisitionCost||""),ie(s.status||"activo"),re(s.condition||"bueno");const z=s.parkId?String(s.parkId):"",D=s.amenityId?String(s.amenityId):"";if(le(z),oe(s.categoryId?String(s.categoryId):""),j(s.locationDescription||""),S(D),$(s.latitude||""),T(s.longitude||""),ve(we),fe(De),s.latitude&&s.longitude){const m=parseFloat(s.latitude),r=parseFloat(s.longitude);!isNaN(m)&&!isNaN(r)&&(R([m,r]),V([m,r]))}else if(s.parkId){const r=await(await fetch(`/api/parks/${s.parkId}`)).json();if(r.latitude&&r.longitude){const U=parseFloat(r.latitude),p=parseFloat(r.longitude);!isNaN(U)&&!isNaN(p)&&V([U,p])}}if(s.acquisitionDate){const m=new Date(s.acquisitionDate+"T00:00:00");q(m.toISOString().split("T")[0])}else q("");if(z){const r=await(await fetch(`/api/parks/${z}/amenities`)).json();if(O(r),D&&!r.find(p=>p.id===parseInt(D))){const p=r.find(Ee=>Ee.amenityId===parseInt(D));p&&S(String(p.id))}}Se(!0)}catch(i){console.error("Error al cargar datos:",i),u("Error al cargar los datos del activo")}})()},[l]);const[w,Se]=t.useState(!1);t.useEffect(()=>{o&&w?fetch(`/api/parks/${o}/amenities`).then(a=>a.json()).then(a=>O(a)).catch(a=>console.error("Error al cargar amenidades:",a)):!o&&w&&(O([]),S(""),j(""))},[o,w]);const Ce=async a=>{if(le(a),w&&(S(""),j("")),a)try{const i=await fetch(`/api/parks/${a}`);if(i.ok){const c=await i.json();if(c.latitude&&c.longitude){const f=parseFloat(c.latitude),s=parseFloat(c.longitude);!isNaN(f)&&!isNaN(s)&&V([f,s])}}}catch(i){console.error("Error al cargar ubicación del parque:",i)}},ye=a=>{if(S(a),a&&a!=="none"){const i=he.find(c=>c.id===parseInt(a));i&&j(i.moduleName||i.name||"")}else j("")},Ie=a=>{R(a),$(a[0].toFixed(6)),T(a[1].toFixed(6))},me=()=>{const a=parseFloat(L),i=parseFloat(M);!isNaN(a)&&!isNaN(i)&&R([a,i])},ke=async()=>{if(!l){u("ID de activo no válido");return}if(!E.trim()){u("El nombre es obligatorio");return}if(!o){u("Debe seleccionar un parque");return}if(!F){u("Debe seleccionar una categoría");return}Q(!0),u(""),_("");try{const a={name:E.trim(),description:W.trim(),serialNumber:Y.trim(),notes:ee.trim(),acquisitionCost:A?A.trim():void 0,status:te,condition:ne,parkId:parseInt(o),categoryId:parseInt(F),location:ce.trim(),acquisitionDate:de||void 0,amenityId:v&&v!=="none"?parseInt(v):null,latitude:L.trim()||void 0,longitude:M.trim()||void 0},i=await fetch(`/api/assets/${l}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)});if(!i.ok){const f=await i.text();throw new Error(`Error HTTP ${i.status}: ${f}`)}const c=await i.json();b.invalidateQueries({queryKey:[`/api/assets/${l}`]}),b.invalidateQueries({queryKey:["/api/assets"]}),_("Activo actualizado correctamente"),setTimeout(()=>{N(`/admin/assets/${l}`)},1500)}catch(a){console.error("Error al guardar:",a),u("Error al actualizar el activo. Por favor, intente de nuevo.")}finally{Q(!1)}};return e.jsx(Le,{children:e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>N(`/admin/assets/${l}`),children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),"Volver"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Editar Activo"})]}),e.jsxs(Me,{className:"max-w-4xl",children:[e.jsx(Te,{children:e.jsx(Re,{children:"Información del Activo"})}),e.jsxs(Pe,{className:"space-y-6",children:[H&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:H}),K&&e.jsx("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded",children:K}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"name",children:"Nombre *"}),e.jsx(g,{id:"name",value:E,onChange:a=>J(a.target.value),placeholder:"Nombre del activo"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"serialNumber",children:"Número de Serie"}),e.jsx(g,{id:"serialNumber",value:Y,onChange:a=>Z(a.target.value),placeholder:"Número de serie"})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"description",children:"Descripción"}),e.jsx(pe,{id:"description",value:W,onChange:a=>X(a.target.value),placeholder:"Descripción del activo",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{children:"Parque *"}),e.jsxs(C,{value:o,onValueChange:Ce,children:[e.jsx(y,{children:e.jsx(I,{placeholder:"Seleccionar parque"})}),e.jsx(k,{children:h&&(Array.isArray(h)?h:h.data||[]).length>0?(Array.isArray(h)?h:h.data||[]).map(a=>e.jsx(d,{value:String(a.id),children:a.name},a.id)):e.jsx(d,{value:"loading",disabled:!0,children:"Cargando parques..."})})]})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Categoría *"}),e.jsxs(C,{value:F,onValueChange:oe,children:[e.jsx(y,{children:e.jsx(I,{placeholder:"Seleccionar categoría"})}),e.jsx(k,{children:ue.length>0?ue.map(a=>e.jsx(d,{value:String(a.id),children:a.name},a.id)):e.jsx(d,{value:"loading",disabled:!0,children:"Cargando categorías..."})})]})]})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Amenidad (Opcional)"}),e.jsxs(C,{value:v,onValueChange:ye,disabled:!o,children:[e.jsx(y,{children:e.jsx(I,{placeholder:o?"Seleccionar amenidad":"Primero seleccione un parque"})}),e.jsxs(k,{children:[e.jsx(d,{value:"none",children:"Sin amenidad"}),he.map(a=>e.jsx(d,{value:String(a.id),children:a.name||a.moduleName||a.amenityName||`Amenidad ${a.id}`},a.id))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{children:"Estado"}),e.jsxs(C,{value:te,onValueChange:ie,children:[e.jsx(y,{children:e.jsx(I,{placeholder:"Seleccionar estado"})}),e.jsx(k,{children:Ne.map(a=>e.jsx(d,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Condición"}),e.jsxs(C,{value:ne,onValueChange:re,children:[e.jsx(y,{children:e.jsx(I,{placeholder:"Seleccionar condición"})}),e.jsx(k,{children:be.map(a=>e.jsx(d,{value:a.value,children:a.label},a.value))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"cost",children:"Costo de Adquisición"}),e.jsx(g,{id:"cost",type:"number",step:"0.01",value:A,onChange:a=>se(a.target.value),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"acquisitionDate",children:"Fecha de Adquisición"}),e.jsx(g,{id:"acquisitionDate",type:"date",value:de,onChange:a=>q(a.target.value)})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"location",children:"Descripción de Ubicación"}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(g,{id:"location",value:ce,onChange:a=>j(a.target.value),placeholder:v&&v!=="none"?"Se completó automáticamente desde la amenidad":"Descripción manual de la ubicación",className:"pl-10"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5 text-blue-600"}),e.jsx(n,{className:"text-lg font-medium",children:"Ubicación Geográfica"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"latitude",children:"Latitud"}),e.jsx(g,{id:"latitude",value:L,onChange:a=>$(a.target.value),onBlur:me,placeholder:"Ej: 19.432608"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"longitude",children:"Longitud"}),e.jsx(g,{id:"longitude",value:M,onChange:a=>T(a.target.value),onBlur:me,placeholder:"Ej: -99.133209"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Mapa Interactivo"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Haz clic en el mapa para establecer la ubicación del activo"}),e.jsx("div",{className:"h-64 w-full border rounded-lg overflow-hidden",children:e.jsxs(Oe,{center:P,zoom:13,style:{height:"100%",width:"100%"},children:[e.jsx(ze,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(Ge,{position:je,setPosition:Ie})]},`${P[0]}-${P[1]}`)})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"notes",children:"Notas"}),e.jsx(pe,{id:"notes",value:ee,onChange:a=>ae(a.target.value),placeholder:"Notas adicionales sobre el activo",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(B,{variant:"outline",onClick:()=>N(`/admin/assets/${l}`),children:"Cancelar"}),e.jsx(B,{onClick:ke,disabled:G,children:G?"Guardando...":e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Guardar Cambios"]})})]})]})]})]})})}export{_e as default};
