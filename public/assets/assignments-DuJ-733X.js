import{Y as S,a6 as me,u as M,a8 as K,j as e,aI as he,D as je,p as ge,B as v,b2 as pe,r as fe,t as ve,v as ye,C as _,a as E,b as F,d3 as O,c as T,a9 as W,i as Z,I as R,z as P,H as I,J as V,K as L,N as x,a5 as p,f as Q,ba as Ne,bb as we,l as k,X as z,a7 as be,ah as De,aa as Ce,ab as N,ac as w,ad as b,ae as D,af as C,bB as H,bC as G,bD as X,h as $,bE as J,bF as U,d4 as Ae,x as Se,ai as Y,bG as q}from"./index-Dzu3mJf5.js";import{C as ee}from"./circle-x-C53LJYQf.js";const _e=p.object({ad_space_id:p.string().min(1,"Espacio publicitario es requerido"),advertisement_id:p.string().min(1,"Anuncio es requerido"),start_date:p.date({required_error:"Fecha de inicio es requerida"}),end_date:p.date({required_error:"Fecha de fin es requerida"}),frequency:p.enum(["always","weekly","daily","hourly"]).default("always"),priority:p.number().min(1).max(10).default(5),is_active:p.boolean().default(!0)}),Ee=({src:t,alt:f})=>{const[c,i]=S.useState(!1);return!t||c?e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center border border-blue-200",children:e.jsx(Ae,{className:"w-6 h-6 text-blue-500"})}):e.jsx("img",{src:t,alt:f,className:"w-full h-full object-cover",loading:"lazy",onError:()=>i(!0)})},Fe=({assignment:t,onEdit:f,onDelete:c})=>{const i=t.startDate?new Date(t.startDate):null,d=t.endDate?new Date(t.endDate):null,l=new Date,h=t.isActive&&i&&d&&!isNaN(i.getTime())&&!isNaN(d.getTime())&&l>=i&&l<=d,u=d&&!isNaN(d.getTime())&&l>d,j=i&&!isNaN(i.getTime())&&l<i,g=()=>h?e.jsx(W,{className:"w-4 h-4 text-green-500"}):u?e.jsx(ee,{className:"w-4 h-4 text-red-500"}):j?e.jsx(Z,{className:"w-4 h-4 text-yellow-500"}):e.jsx(Se,{className:"w-4 h-4 text-gray-500"}),y=()=>h?"Activo":u?"Expirado":j?"Pendiente":"Inactivo",s=()=>h?"bg-green-100 text-green-800":u?"bg-red-100 text-red-800":j?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800";return e.jsxs(_,{className:"hover:shadow-lg transition-shadow h-full",children:[e.jsx(E,{className:"pb-3",children:e.jsxs("div",{className:"flex justify-between items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(F,{className:"text-lg truncate",children:t.advertisement.title}),e.jsx("p",{className:"text-sm text-gray-600 mt-1 truncate",children:t.space.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 flex-wrap",children:[g(),e.jsx(Q,{className:s(),children:y()}),e.jsxs(Q,{variant:"outline",children:["Prioridad ",t.priority]})]})]}),e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsx(v,{variant:"outline",size:"sm",onClick:()=>f(t),className:"h-8 w-8 p-0",children:e.jsx(Ne,{className:"w-4 h-4"})}),e.jsx(v,{variant:"destructive",size:"sm",onClick:()=>c(t.id),className:"h-8 w-8 p-0",children:e.jsx(we,{className:"w-4 h-4"})})]})]})}),e.jsx(T,{className:"pt-0",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-700",children:"Espacio:"}),e.jsxs("p",{className:"text-gray-600 truncate",children:[t.space.pageType," - ",t.space.position]})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-700",children:"Frecuencia:"}),e.jsx("p",{className:"text-gray-600 truncate",children:t.frequency})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-700",children:"Fecha inicio:"}),e.jsx("p",{className:"text-gray-600",children:t.startDate?(()=>{try{return k(new Date(t.startDate),"dd/MM/yyyy",{locale:z})}catch{return"Fecha inválida"}})():"Sin fecha"})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-700",children:"Fecha fin:"}),e.jsx("p",{className:"text-gray-600",children:t.endDate?(()=>{try{return k(new Date(t.endDate),"dd/MM/yyyy",{locale:z})}catch{return"Fecha inválida"}})():"Sin fecha"})]})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-2",children:"Vista previa:"}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex-shrink-0 overflow-hidden border border-blue-200",children:e.jsx(Ee,{src:t.advertisement.imageUrl,alt:t.advertisement.title||"Vista previa del anuncio"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:t.advertisement.title||"Sin título"}),e.jsx("p",{className:"text-xs text-gray-600 line-clamp-2 mt-1",children:t.advertisement.description||"Sin descripción"})]})]})]})]})})]})},Te=({assignment:t,onSubmit:f,onCancel:c})=>{const i=be({resolver:De(_e),defaultValues:t?{ad_space_id:t.adSpaceId.toString(),advertisement_id:t.advertisementId.toString(),start_date:new Date(t.startDate),end_date:new Date(t.endDate),frequency:t.frequency,priority:t.priority,is_active:t.isActive}:{ad_space_id:"",advertisement_id:"",frequency:"always",priority:5,is_active:!0}}),{data:d}=M({queryKey:["/api/advertising-management/spaces"]}),{data:l}=M({queryKey:["/api/advertising-management/advertisements"]}),h=(d==null?void 0:d.data)||d||[],u=(l==null?void 0:l.data)||l||[],j=s=>{f(s)},g=Array.isArray(h)?h.filter(s=>s&&s.id&&s.name):[],y=Array.isArray(u)?u.filter(s=>s&&s.id&&s.title):[];return e.jsx(Ce,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(j),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(N,{control:i.control,name:"ad_space_id",render:({field:s})=>e.jsxs(w,{children:[e.jsx(b,{children:"Espacio Publicitario"}),e.jsxs(P,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(D,{children:e.jsx(I,{children:e.jsx(V,{placeholder:"Selecciona un espacio"})})}),e.jsx(L,{children:g.map(n=>e.jsxs(x,{value:n.id.toString(),children:[n.name," (",n.pageType," - ",n.position,")"]},n.id))})]}),e.jsx(C,{})]})}),e.jsx(N,{control:i.control,name:"advertisement_id",render:({field:s})=>e.jsxs(w,{children:[e.jsx(b,{children:"Anuncio"}),e.jsxs(P,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(D,{children:e.jsx(I,{children:e.jsx(V,{placeholder:"Selecciona un anuncio"})})}),e.jsx(L,{children:y.map(n=>e.jsx(x,{value:n.id.toString(),children:n.title},n.id))})]}),e.jsx(C,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(N,{control:i.control,name:"start_date",render:({field:s})=>e.jsxs(w,{className:"flex flex-col",children:[e.jsx(b,{children:"Fecha de Inicio"}),e.jsxs(H,{children:[e.jsx(G,{asChild:!0,children:e.jsx(D,{children:e.jsxs(v,{variant:"outline",className:X("w-full pl-3 text-left font-normal",!s.value&&"text-muted-foreground"),children:[s.value?k(s.value,"PPP",{locale:z}):e.jsx("span",{children:"Selecciona una fecha"}),e.jsx($,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(J,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:s.value,onSelect:s.onChange,disabled:n=>n<new Date,initialFocus:!0})})]}),e.jsx(C,{})]})}),e.jsx(N,{control:i.control,name:"end_date",render:({field:s})=>e.jsxs(w,{className:"flex flex-col",children:[e.jsx(b,{children:"Fecha de Fin"}),e.jsxs(H,{children:[e.jsx(G,{asChild:!0,children:e.jsx(D,{children:e.jsxs(v,{variant:"outline",className:X("w-full pl-3 text-left font-normal",!s.value&&"text-muted-foreground"),children:[s.value?k(s.value,"PPP",{locale:z}):e.jsx("span",{children:"Selecciona una fecha"}),e.jsx($,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(J,{className:"w-auto p-0",align:"start",children:e.jsx(U,{mode:"single",selected:s.value,onSelect:s.onChange,disabled:n=>n<new Date,initialFocus:!0})})]}),e.jsx(C,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(N,{control:i.control,name:"frequency",render:({field:s})=>e.jsxs(w,{children:[e.jsx(b,{children:"Frecuencia"}),e.jsxs(P,{onValueChange:s.onChange,defaultValue:s.value,children:[e.jsx(D,{children:e.jsx(I,{children:e.jsx(V,{placeholder:"Selecciona frecuencia"})})}),e.jsxs(L,{children:[e.jsx(x,{value:"always",children:"Siempre"}),e.jsx(x,{value:"weekly",children:"Semanal"}),e.jsx(x,{value:"daily",children:"Diario"}),e.jsx(x,{value:"hourly",children:"Por hora"})]})]}),e.jsx(C,{})]})}),e.jsx(N,{control:i.control,name:"priority",render:({field:s})=>e.jsxs(w,{children:[e.jsx(b,{children:"Prioridad (1-10)"}),e.jsx(D,{children:e.jsx(R,{type:"number",min:1,max:10,...s,onChange:n=>s.onChange(parseInt(n.target.value))})}),e.jsx(C,{})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(v,{type:"button",variant:"outline",onClick:c,children:"Cancelar"}),e.jsxs(v,{type:"submit",children:[t?"Actualizar":"Crear"," Asignación"]})]})]})})};function Ve(){const[t,f]=S.useState(""),[c,i]=S.useState("all"),[d,l]=S.useState(!1),[h,u]=S.useState(),j=me(),{data:g,isLoading:y}=M({queryKey:["/api/advertising-management/assignments"]}),s=(g==null?void 0:g.data)||g||[],n=K({mutationFn:async a=>{const r=parseInt(a.ad_space_id),m=parseInt(a.advertisement_id);if(isNaN(r)||isNaN(m))throw new Error("Los IDs de espacio y anuncio deben ser números válidos");const o={ad_space_id:r,advertisement_id:m,start_date:a.start_date.toISOString(),end_date:a.end_date.toISOString(),frequency:a.frequency,priority:a.priority,is_active:a.is_active};return console.log("Enviando payload de asignación:",o),Y("/api/advertising-management/assignments",{method:"POST",data:o})},onSuccess:()=>{j.invalidateQueries({queryKey:["/api/advertising-management/assignments"]}),l(!1),u(void 0),q({title:"Asignación creada",description:"La asignación publicitaria ha sido creada exitosamente."})},onError:a=>{q({title:"Error",description:"No se pudo crear la asignación. Intenta nuevamente.",variant:"destructive"}),console.error("Error creating assignment:",a)}}),ae=K({mutationFn:async a=>Y(`/api/advertising-management/assignments/${a}`,{method:"DELETE"}),onSuccess:()=>{j.invalidateQueries({queryKey:["/api/advertising-management/assignments"]}),q({title:"Asignación eliminada",description:"La asignación publicitaria ha sido eliminada - Actualizando banners..."})},onError:a=>{q({title:"Error",description:"No se pudo eliminar la asignación.",variant:"destructive"}),console.error("Error deleting assignment:",a)}}),se=a=>{n.mutate(a)},te=a=>{u(a),l(!0)},re=a=>{confirm("¿Estás seguro de que deseas eliminar esta asignación?")&&ae.mutate(a)},ie=()=>{l(!1),u(void 0)},B=Array.isArray(s)?s.filter(a=>{if(!a||!a.advertisement||!a.space)return!1;const r=(a.advertisement.title||"").toLowerCase().includes(t.toLowerCase())||(a.space.name||"").toLowerCase().includes(t.toLowerCase());if(c==="all")return r;const m=new Date;let o,A;try{o=a.startDate?new Date(a.startDate):null,A=a.endDate?new Date(a.endDate):null}catch{return!1}if(!o||!A||isNaN(o.getTime())||isNaN(A.getTime()))return!1;const oe=a.isActive&&m>=o&&m<=A,xe=m>A,ue=m<o;return c==="active"&&oe||c==="expired"&&xe||c==="pending"&&ue||c==="inactive"&&!a.isActive?r:!1}):[],ne=Array.isArray(s)?s.length:0,le=Array.isArray(s)?s.filter(a=>{if(!a||!a.startDate||!a.endDate)return!1;try{const r=new Date,m=new Date(a.startDate),o=new Date(a.endDate);return a.isActive&&!isNaN(m.getTime())&&!isNaN(o.getTime())&&r>=m&&r<=o}catch{return!1}}).length:0,ce=Array.isArray(s)?s.filter(a=>{if(!a||!a.endDate)return!1;try{const r=new Date(a.endDate);return!isNaN(r.getTime())&&new Date>r}catch{return!1}}).length:0,de=Array.isArray(s)?s.filter(a=>{if(!a||!a.startDate)return!1;try{const r=new Date(a.startDate);return!isNaN(r.getTime())&&new Date<r}catch{return!1}}).length:0;return e.jsx(he,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Asignaciones Publicitarias"}),e.jsx("p",{className:"text-gray-600",children:"Gestiona la programación y distribución de anuncios en espacios publicitarios"})]}),e.jsxs(je,{open:d,onOpenChange:l,children:[e.jsx(ge,{asChild:!0,children:e.jsxs(v,{children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Nueva Asignación"]})}),e.jsxs(fe,{className:"max-w-4xl",children:[e.jsx(ve,{children:e.jsx(ye,{children:h?"Editar Asignación":"Nueva Asignación"})}),e.jsx(Te,{assignment:h,onSubmit:se,onCancel:ie})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(_,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Total Asignaciones"}),e.jsx(O,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold",children:ne})})]}),e.jsxs(_,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Activas"}),e.jsx(W,{className:"h-4 w-4 text-green-500"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:le})})]}),e.jsxs(_,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Pendientes"}),e.jsx(Z,{className:"h-4 w-4 text-yellow-500"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:de})})]}),e.jsxs(_,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:"Expiradas"}),e.jsx(ee,{className:"h-4 w-4 text-red-500"})]}),e.jsx(T,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:ce})})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(R,{placeholder:"Buscar por anuncio o espacio...",value:t,onChange:a=>f(a.target.value),className:"w-full"})}),e.jsxs(P,{value:c,onValueChange:i,children:[e.jsx(I,{className:"w-full md:w-48",children:e.jsx(V,{placeholder:"Filtrar por estado"})}),e.jsxs(L,{children:[e.jsx(x,{value:"all",children:"Todos"}),e.jsx(x,{value:"active",children:"Activas"}),e.jsx(x,{value:"pending",children:"Pendientes"}),e.jsx(x,{value:"expired",children:"Expiradas"}),e.jsx(x,{value:"inactive",children:"Inactivas"})]})]})]}),y?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Cargando asignaciones..."})]}):e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-4 lg:gap-6",children:B.map(a=>e.jsx(Fe,{assignment:a,onEdit:te,onDelete:re},a.id))}),B.length===0&&!y&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(O,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No hay asignaciones"}),e.jsx("p",{className:"text-gray-500",children:t||c!=="all"?"No se encontraron asignaciones con los filtros aplicados.":"Aún no tienes asignaciones publicitarias. Crea la primera para comenzar."})]})]})})}export{Ve as default};
