import{am as Se,Y as c,e as Te,a6 as De,u as Z,a8 as j,R as Me,j as e,aI as ee,B as i,A as Fe,D as C,p as Ie,b2 as Pe,r as E,t as S,v as T,w as D,z as L,H as B,J as R,K as V,N as M,O as F,I as d,C as se,c as ae,Z as ze,a as Ae,b as ke,bh as qe,bi as $e,bj as K,bk as u,bl as Le,bm as m,f as te,b7 as Be,ba as Re,bb as Ve,as as Ke,az as ne,i as Oe,aL as Qe,a9 as He,aJ as Ue,l as _e,X as Ye,ai as I}from"./index-Dzu3mJf5.js";const f=[{value:"preventivo",label:"Preventivo"},{value:"correctivo",label:"Correctivo"},{value:"predictivo",label:"Predictivo"},{value:"inspeccion",label:"Inspección"},{value:"limpieza",label:"Limpieza"}],g=[{value:"scheduled",label:"Programado",color:"bg-blue-100 text-blue-800",icon:Oe},{value:"in_progress",label:"En Progreso",color:"bg-orange-100 text-orange-800",icon:Qe},{value:"completed",label:"Completado",color:"bg-green-100 text-green-800",icon:He},{value:"cancelled",label:"Cancelado",color:"bg-gray-100 text-gray-800",icon:Ue}],Ge=()=>{var X,G,W;const[Je,ie]=Se(),[v,le]=c.useState(""),[b,oe]=c.useState("all"),[re,P]=c.useState(!1),[ce,O]=c.useState(!1),[de,N]=c.useState(!1),[me,y]=c.useState(!1),[t,h]=c.useState(null),[r,z]=c.useState(null),[Q,H]=c.useState(!1),{toast:l}=Te(),p=De(),A=s=>{try{const a=new Date(s+"T00:00:00");return _e(a,"dd/MM/yyyy",{locale:Ye})}catch{return s}},ue=s=>{try{return s.split("T")[0]}catch{return s}},{data:U=[],isLoading:xe}=Z({queryKey:["/api/asset-maintenances"],staleTime:6e4}),{data:he=[]}=Z({queryKey:["/api/assets"],staleTime:6e4}),k=j({mutationFn:async s=>I(`/api/assets/${s.assetId}/maintenances`,{method:"POST",data:s}),onSuccess:async s=>{if(r&&r.length>0)try{const a=new FormData;Array.from(r).forEach(n=>{a.append("photos",n)}),await fetch(`/api/maintenance-photos/${s.id}`,{method:"POST",body:a})}catch(a){console.error("Error subiendo fotos:",a),l({title:"Mantenimiento creado",description:"El mantenimiento se creó pero hubo un error al subir las fotos.",variant:"destructive"})}p.invalidateQueries({queryKey:["/api/asset-maintenances"]}),l({title:"Mantenimiento registrado",description:r?"El mantenimiento y las fotos se han registrado correctamente.":"El mantenimiento se ha registrado correctamente."}),P(!1),z(null)},onError:()=>{l({title:"Error",description:"No se pudo registrar el mantenimiento.",variant:"destructive"})}}),q=j({mutationFn:async s=>I(`/api/asset-maintenances/${s.id}`,{method:"PUT",data:s}),onSuccess:async s=>{await p.invalidateQueries({queryKey:["/api/asset-maintenances"]}),await p.refetchQueries({queryKey:["/api/asset-maintenances"]}),l({title:"Mantenimiento actualizado",description:"El mantenimiento se ha actualizado correctamente."}),N(!1),h(null)},onError:()=>{l({title:"Error",description:"No se pudo actualizar el mantenimiento.",variant:"destructive"})}}),$=j({mutationFn:async s=>I(`/api/asset-maintenances/${s}`,{method:"DELETE"}),onSuccess:()=>{p.invalidateQueries({queryKey:["/api/asset-maintenances"]}),l({title:"Mantenimiento eliminado",description:"El mantenimiento se ha eliminado correctamente."}),y(!1),h(null)},onError:()=>{l({title:"Error",description:"No se pudo eliminar el mantenimiento.",variant:"destructive"})}}),pe=j({mutationFn:async({maintenanceId:s,files:a})=>{console.log("📸 Iniciando subida de fotos desde frontend"),console.log("Maintenance ID:",s),console.log("Files count:",a.length);const n=new FormData;Array.from(a).forEach((x,Ee)=>{console.log(`Agregando archivo ${Ee+1}:`,x.name,x.type,x.size),n.append("photos",x)});const o=await fetch(`/api/maintenance-photos/${s}`,{method:"POST",body:n,credentials:"include"});if(!o.ok){const x=await o.text();throw console.error("Error response:",o.status,x),new Error(`Error al subir fotos: ${o.status} - ${x}`)}const w=await o.json();return console.log("✅ Fotos subidas exitosamente:",w),w},onSuccess:async s=>{console.log("🎯 Actualizando interfaz después de subir fotos"),await p.invalidateQueries({queryKey:["/api/asset-maintenances"]}),t&&s.maintenance&&(console.log("📋 Actualizando mantenimiento seleccionado con nuevas fotos:",s.maintenance.photos),h(s.maintenance)),l({title:"Fotos subidas",description:"Las fotos se han subido correctamente."}),z(null)},onError:s=>{console.error("❌ Error al subir fotos:",s),l({title:"Error",description:`No se pudieron subir las fotos: ${s.message}`,variant:"destructive"})}}),je=j({mutationFn:async({maintenanceId:s,photoIndex:a})=>I(`/api/maintenance-photos/${s}/${a}`,{method:"DELETE"}),onSuccess:()=>{p.invalidateQueries({queryKey:["/api/asset-maintenances"]}),l({title:"Foto eliminada",description:"La foto se ha eliminado correctamente."})},onError:()=>{l({title:"Error",description:"No se pudo eliminar la foto.",variant:"destructive"})}}),_=Me.useMemo(()=>U.filter(s=>{var o;const a=((o=s.assetName)==null?void 0:o.toLowerCase().includes(v.toLowerCase()))||s.description.toLowerCase().includes(v.toLowerCase()),n=b==="all"||s.status===b;return a&&n}),[U,v,b]),fe=s=>{s.preventDefault();const a=new FormData(s.currentTarget),n={assetId:parseInt(a.get("assetId")),maintenanceType:a.get("maintenanceType"),description:a.get("description"),date:a.get("date"),status:a.get("status"),cost:a.get("cost")?parseFloat(a.get("cost")):null,performedBy:a.get("performedBy"),notes:a.get("notes")};console.log("📝 Datos del mantenimiento enviados:",n),k.mutate(n)},ge=s=>{if(s.preventDefault(),!t)return;const a=new FormData(s.currentTarget),n={id:t.id,assetId:t.assetId,maintenanceType:a.get("maintenanceType"),description:a.get("description"),date:a.get("date"),status:a.get("status"),cost:a.get("cost")?parseFloat(a.get("cost")):null,performedBy:a.get("performedBy"),notes:a.get("notes")};q.mutate(n)},ve=s=>{h(s),O(!0)},be=s=>{h(s),N(!0)},Ne=s=>{h(s),y(!0)},ye=()=>{t&&$.mutate(t.id)},Y=s=>{const a=s.target.files;a&&a.length>0&&z(a)},we=()=>{t&&r&&(H(!0),pe.mutate({maintenanceId:t.id,files:r},{onSettled:()=>H(!1)}))},Ce=s=>{t&&je.mutate({maintenanceId:t.id,photoIndex:s})},J=s=>g.find(a=>a.value===s)||g[0];return xe?e.jsx(ee,{children:e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"text-center",children:"Cargando mantenimientos..."})})}):e.jsxs(ee,{children:[e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(i,{variant:"outline",onClick:()=>ie("/admin/assets"),children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Volver a Activos"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Gestión de Mantenimientos"}),e.jsx("p",{className:"text-muted-foreground",children:"Registra y gestiona el mantenimiento de activos"})]})]}),e.jsxs(C,{open:re,onOpenChange:P,children:[e.jsx(Ie,{asChild:!0,children:e.jsxs(i,{children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),"Registrar Mantenimiento"]})}),e.jsxs(E,{className:"max-w-md max-h-[90vh] overflow-y-auto",children:[e.jsxs(S,{children:[e.jsx(T,{children:"Registrar Nuevo Mantenimiento"}),e.jsx(D,{children:"Complete los datos del mantenimiento realizado"})]}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Activo"}),e.jsxs(L,{name:"assetId",required:!0,children:[e.jsx(B,{children:e.jsx(R,{placeholder:"Seleccionar activo"})}),e.jsx(V,{children:he.map(s=>e.jsxs(M,{value:s.id.toString(),children:[s.name," - ",s.parkName]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Tipo de Mantenimiento"}),e.jsxs(L,{name:"maintenanceType",required:!0,children:[e.jsx(B,{children:e.jsx(R,{placeholder:"Seleccionar tipo"})}),e.jsx(V,{children:f.map(s=>e.jsx(M,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Descripción"}),e.jsx(F,{name:"description",placeholder:"Descripción del mantenimiento realizado",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Fecha"}),e.jsx(d,{name:"date",type:"date",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Estado"}),e.jsx("select",{name:"status",defaultValue:"scheduled",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",children:g.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:'💡 Sugerencia: "Programado" para fechas futuras, "Completado" para fechas pasadas'})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Costo (opcional)"}),e.jsx(d,{name:"cost",type:"number",step:"0.01",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Realizado por"}),e.jsx(d,{name:"performedBy",placeholder:"Nombre del responsable"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Notas"}),e.jsx(F,{name:"notes",placeholder:"Notas adicionales"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Fotos de Evidencia (opcional)"}),e.jsx(d,{type:"file",accept:"image/*",multiple:!0,onChange:Y,className:"file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"}),r&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[r.length," archivo(s) seleccionado(s) - se subirán después de crear el mantenimiento"]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>P(!1),children:"Cancelar"}),e.jsx(i,{type:"submit",disabled:k.isPending,children:k.isPending?"Registrando...":"Registrar"})]})]})]})]})]}),e.jsx(se,{className:"mb-6",children:e.jsx(ae,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ze,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(d,{placeholder:"Buscar por activo o descripción...",value:v,onChange:s=>le(s.target.value),className:"pl-10"})]})}),e.jsxs(L,{value:b,onValueChange:oe,children:[e.jsx(B,{className:"w-[180px]",children:e.jsx(R,{placeholder:"Estado"})}),e.jsxs(V,{children:[e.jsx(M,{value:"all",children:"Todos los estados"}),g.map(s=>e.jsx(M,{value:s.value,children:s.label},s.value))]})]})]})})}),e.jsxs(se,{children:[e.jsx(Ae,{children:e.jsx(ke,{children:"Historial de Mantenimientos"})}),e.jsx(ae,{children:e.jsxs(qe,{children:[e.jsx($e,{children:e.jsxs(K,{children:[e.jsx(u,{children:"Activo"}),e.jsx(u,{children:"Tipo"}),e.jsx(u,{children:"Descripción"}),e.jsx(u,{children:"Fecha"}),e.jsx(u,{children:"Estado"}),e.jsx(u,{children:"Realizado por"}),e.jsx(u,{children:"Costo"}),e.jsx(u,{className:"text-right",children:"Acciones"})]})}),e.jsx(Le,{children:_.length===0?e.jsx(K,{children:e.jsx(m,{colSpan:8,className:"text-center py-6 text-muted-foreground",children:"No se encontraron mantenimientos registrados"})}):_.map(s=>{var o;const a=J(s.status),n=a.icon;return e.jsxs(K,{children:[e.jsx(m,{className:"font-medium",children:s.assetName||`Activo #${s.assetId}`}),e.jsx(m,{children:((o=f.find(w=>w.value===s.maintenanceType))==null?void 0:o.label)||s.maintenanceType}),e.jsx(m,{className:"max-w-xs truncate",children:s.description}),e.jsx(m,{children:A(s.date)}),e.jsx(m,{children:e.jsxs(te,{className:a.color,children:[e.jsx(n,{className:"w-3 h-3 mr-1"}),a.label]})}),e.jsx(m,{children:s.performedBy||"-"}),e.jsx(m,{children:s.cost?`$${parseFloat(s.cost.toString()).toFixed(2)}`:"-"}),e.jsx(m,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>ve(s),children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>be(s),children:e.jsx(Re,{className:"h-4 w-4"})}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>Ne(s),children:e.jsx(Ve,{className:"h-4 w-4"})})]})})]},s.id)})})]})})]})]}),e.jsx(C,{open:ce,onOpenChange:O,children:e.jsxs(E,{className:"max-w-md max-h-[90vh] overflow-y-auto",children:[e.jsxs(S,{children:[e.jsx(T,{children:"Detalles del Mantenimiento"}),e.jsx(D,{children:"Información completa del mantenimiento registrado"})]}),t&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Activo"}),e.jsx("p",{className:"text-sm",children:t.assetName||`Activo #${t.assetId}`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Tipo de Mantenimiento"}),e.jsx("p",{className:"text-sm",children:((X=f.find(s=>s.value===t.maintenanceType))==null?void 0:X.label)||t.maintenanceType})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Descripción"}),e.jsx("p",{className:"text-sm",children:t.description})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Fecha"}),e.jsx("p",{className:"text-sm",children:A(t.date)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Estado"}),e.jsx("div",{className:"mt-1",children:(()=>{const s=J(t.status),a=s.icon;return e.jsxs(te,{className:s.color,children:[e.jsx(a,{className:"w-3 h-3 mr-1"}),s.label]})})()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Realizado por"}),e.jsx("p",{className:"text-sm",children:t.performedBy||"No especificado"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Costo"}),e.jsx("p",{className:"text-sm",children:t.cost?`$${parseFloat(t.cost.toString()).toFixed(2)}`:"No especificado"})]}),t.notes&&e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Notas"}),e.jsx("p",{className:"text-sm",children:t.notes})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-muted-foreground",children:"Fotos de Evidencia"}),t.photos&&t.photos.length>0?e.jsx("div",{className:"grid grid-cols-2 gap-2 mt-2",children:t.photos.map((s,a)=>e.jsx("div",{className:"relative",children:e.jsx("img",{src:s,alt:`Evidencia ${a+1}`,className:"w-full h-24 object-cover rounded-md border",onClick:()=>window.open(s,"_blank"),style:{cursor:"pointer"}})},a))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No hay fotos de evidencia"})]})]})]})}),e.jsx(C,{open:de,onOpenChange:N,children:e.jsxs(E,{className:"max-w-md max-h-[90vh] overflow-y-auto",children:[e.jsxs(S,{children:[e.jsx(T,{children:"Editar Mantenimiento"}),e.jsx(D,{children:"Modifica la información del mantenimiento"})]}),t&&e.jsxs("form",{onSubmit:ge,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Tipo de Mantenimiento"}),e.jsx("select",{name:"maintenanceType",required:!0,defaultValue:t.maintenanceType,className:"w-full mt-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:f.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Descripción"}),e.jsx(F,{name:"description",defaultValue:t.description,placeholder:"Describe el mantenimiento realizado",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Fecha"}),e.jsx(d,{type:"date",name:"date",defaultValue:ue(t.date),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Estado"}),e.jsx("select",{name:"status",required:!0,defaultValue:t.status,className:"w-full mt-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:g.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Costo (opcional)"}),e.jsx(d,{type:"number",step:"0.01",name:"cost",defaultValue:((G=t.cost)==null?void 0:G.toString())||"",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Realizado por (opcional)"}),e.jsx(d,{name:"performedBy",defaultValue:t.performedBy||"",placeholder:"Nombre del técnico o empresa"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Notas (opcional)"}),e.jsx(F,{name:"notes",defaultValue:t.notes||"",placeholder:"Observaciones adicionales"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Fotos de Evidencia"}),t.photos&&t.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2 mt-2 mb-4",children:t.photos.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`Evidencia ${a+1}`,className:"w-full h-20 object-cover rounded-md border"}),e.jsx(i,{type:"button",variant:"destructive",size:"sm",className:"absolute top-1 right-1 h-6 w-6 p-0",onClick:()=>Ce(a),children:e.jsx(Ke,{className:"h-3 w-3"})})]},a))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{type:"file",accept:"image/*",multiple:!0,onChange:Y,className:"file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"}),r&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[r.length," archivo(s) seleccionado(s)"]}),e.jsx(i,{type:"button",size:"sm",onClick:we,disabled:Q,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"mr-2 h-3 w-3 animate-spin"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"mr-2 h-3 w-3"}),"Subir Fotos"]})})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsx(i,{type:"submit",disabled:q.isPending,children:q.isPending?"Actualizando...":"Actualizar"})]})]})]})}),e.jsx(C,{open:me,onOpenChange:y,children:e.jsxs(E,{className:"max-w-md max-h-[90vh] overflow-y-auto",children:[e.jsxs(S,{children:[e.jsx(T,{children:"Eliminar Mantenimiento"}),e.jsx(D,{children:"Esta acción no se puede deshacer. ¿Estás seguro de que deseas eliminar este mantenimiento?"})]}),t&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Activo: ",t.assetName||`Activo #${t.assetId}`]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Tipo: ",(W=f.find(s=>s.value===t.maintenanceType))==null?void 0:W.label]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Fecha: ",A(t.date)]})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(i,{type:"button",variant:"destructive",onClick:ye,disabled:$.isPending,children:$.isPending?"Eliminando...":"Eliminar"})]})]})]})})]})};export{Ge as default};
