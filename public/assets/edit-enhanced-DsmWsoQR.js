import{cl as Fe,al as qe,a6 as Ae,Y as t,j as e,aB as Le,B,A as $e,C as Me,a as Te,b as Re,c as Pe,y as n,I as p,O as pe,z as S,H as C,J as y,K as I,N as d,M as ge}from"./index-BBGHPKhn.js";import{M as Ve,T as Oe,L as xe,a as ze}from"./leaflet-C1l5RZCP.js";import{S as Be}from"./save-BO66L-dX.js";import{u as Ue}from"./hooks-DtJC8wAk.js";delete xe.Icon.Default.prototype._getIconUrl;xe.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});function He({position:g,setPosition:f}){return Ue({click(N){f([N.latlng.lat,N.latlng.lng])}}),g===null?null:e.jsx(ze,{position:g})}function Ye(){const[,g]=Fe("/admin/assets/:id/edit-enhanced"),[,f]=qe(),N=Ae(),[U,H]=t.useState(!1),[G,u]=t.useState(""),[K,Q]=t.useState(""),l=g==null?void 0:g.id,[D,J]=t.useState(""),[Y,_]=t.useState(""),[W,X]=t.useState(""),[Z,ee]=t.useState(""),[E,ae]=t.useState(""),[se,te]=t.useState("activo"),[ie,ne]=t.useState("bueno"),[o,re]=t.useState(""),[F,le]=t.useState(""),[oe,x]=t.useState(""),[ce,q]=t.useState(""),[j,b]=t.useState(""),[A,L]=t.useState(""),[$,M]=t.useState(""),[je,T]=t.useState(null),[R,P]=t.useState([19.432608,-99.133209]),[de,ve]=t.useState([]),[ue,fe]=t.useState([]),[he,V]=t.useState([]),Ne=[{value:"activo",label:"Activo"},{value:"maintenance",label:"En Mantenimiento"},{value:"retired",label:"Retirado"},{value:"storage",label:"En Almacén"}],be=[{value:"excelente",label:"Excelente"},{value:"bueno",label:"Bueno"},{value:"regular",label:"Regular"},{value:"malo",label:"Malo"},{value:"critico",label:"Crítico"}];t.useEffect(()=>{if(!l)return;(async()=>{try{const[i,c,v]=await Promise.all([fetch(`/api/assets/${l}`),fetch("/api/parks"),fetch("/api/asset-categories")]),s=await i.json(),we=await c.json(),De=await v.json();J(s.name||""),_(s.description||""),X(s.serialNumber||""),ee(s.notes||""),ae(s.acquisitionCost||""),te(s.status||"activo"),ne(s.condition||"bueno");const O=s.parkId?String(s.parkId):"",w=s.amenityId?String(s.amenityId):"";if(re(O),le(s.categoryId?String(s.categoryId):""),x(s.locationDescription||""),b(w),L(s.latitude||""),M(s.longitude||""),ve(we),fe(De),s.latitude&&s.longitude){const h=parseFloat(s.latitude),r=parseFloat(s.longitude);!isNaN(h)&&!isNaN(r)&&(T([h,r]),P([h,r]))}else if(s.parkId){const r=await(await fetch(`/api/parks/${s.parkId}`)).json();if(r.latitude&&r.longitude){const z=parseFloat(r.latitude),m=parseFloat(r.longitude);!isNaN(z)&&!isNaN(m)&&P([z,m])}}if(s.acquisitionDate){const h=new Date(s.acquisitionDate+"T00:00:00");q(h.toISOString().split("T")[0])}else q("");if(O){const r=await(await fetch(`/api/parks/${O}/amenities`)).json();if(V(r),w&&!r.find(m=>m.id===parseInt(w))){const m=r.find(Ee=>Ee.amenityId===parseInt(w));m&&b(String(m.id))}}Se(!0)}catch(i){console.error("Error al cargar datos:",i),u("Error al cargar los datos del activo")}})()},[l]);const[k,Se]=t.useState(!1);t.useEffect(()=>{o&&k?fetch(`/api/parks/${o}/amenities`).then(a=>a.json()).then(a=>V(a)).catch(a=>console.error("Error al cargar amenidades:",a)):!o&&k&&(V([]),b(""),x(""))},[o,k]);const Ce=async a=>{if(re(a),k&&(b(""),x("")),a)try{const i=await fetch(`/api/parks/${a}`);if(i.ok){const c=await i.json();if(c.latitude&&c.longitude){const v=parseFloat(c.latitude),s=parseFloat(c.longitude);!isNaN(v)&&!isNaN(s)&&P([v,s])}}}catch(i){console.error("Error al cargar ubicación del parque:",i)}},ye=a=>{if(b(a),a&&a!=="none"){const i=he.find(c=>c.id===parseInt(a));i&&x(i.moduleName||i.name||"")}else x("")},Ie=a=>{T(a),L(a[0].toFixed(6)),M(a[1].toFixed(6))},me=()=>{const a=parseFloat(A),i=parseFloat($);!isNaN(a)&&!isNaN(i)&&T([a,i])},ke=async()=>{if(!l){u("ID de activo no válido");return}if(!D.trim()){u("El nombre es obligatorio");return}if(!o){u("Debe seleccionar un parque");return}if(!F){u("Debe seleccionar una categoría");return}H(!0),u(""),Q("");try{const a={name:D.trim(),description:Y.trim(),serialNumber:W.trim(),notes:Z.trim(),acquisitionCost:E?E.trim():void 0,status:se,condition:ie,parkId:parseInt(o),categoryId:parseInt(F),location:oe.trim(),acquisitionDate:ce||void 0,amenityId:j&&j!=="none"?parseInt(j):null,latitude:A.trim()||void 0,longitude:$.trim()||void 0},i=await fetch(`/api/assets/${l}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)});if(!i.ok){const v=await i.text();throw new Error(`Error HTTP ${i.status}: ${v}`)}const c=await i.json();N.invalidateQueries({queryKey:[`/api/assets/${l}`]}),N.invalidateQueries({queryKey:["/api/assets"]}),Q("Activo actualizado correctamente"),setTimeout(()=>{f(`/admin/assets/${l}`)},1500)}catch(a){console.error("Error al guardar:",a),u("Error al actualizar el activo. Por favor, intente de nuevo.")}finally{H(!1)}};return e.jsx(Le,{children:e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>f(`/admin/assets/${l}`),children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),"Volver"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Editar Activo"})]}),e.jsxs(Me,{className:"max-w-4xl",children:[e.jsx(Te,{children:e.jsx(Re,{children:"Información del Activo"})}),e.jsxs(Pe,{className:"space-y-6",children:[G&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:G}),K&&e.jsx("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded",children:K}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"name",children:"Nombre *"}),e.jsx(p,{id:"name",value:D,onChange:a=>J(a.target.value),placeholder:"Nombre del activo"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"serialNumber",children:"Número de Serie"}),e.jsx(p,{id:"serialNumber",value:W,onChange:a=>X(a.target.value),placeholder:"Número de serie"})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"description",children:"Descripción"}),e.jsx(pe,{id:"description",value:Y,onChange:a=>_(a.target.value),placeholder:"Descripción del activo",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{children:"Parque *"}),e.jsxs(S,{value:o,onValueChange:Ce,children:[e.jsx(C,{children:e.jsx(y,{placeholder:"Seleccionar parque"})}),e.jsx(I,{children:de.length>0?de.map(a=>e.jsx(d,{value:String(a.id),children:a.name},a.id)):e.jsx(d,{value:"loading",disabled:!0,children:"Cargando parques..."})})]})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Categoría *"}),e.jsxs(S,{value:F,onValueChange:le,children:[e.jsx(C,{children:e.jsx(y,{placeholder:"Seleccionar categoría"})}),e.jsx(I,{children:ue.length>0?ue.map(a=>e.jsx(d,{value:String(a.id),children:a.name},a.id)):e.jsx(d,{value:"loading",disabled:!0,children:"Cargando categorías..."})})]})]})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Amenidad (Opcional)"}),e.jsxs(S,{value:j,onValueChange:ye,disabled:!o,children:[e.jsx(C,{children:e.jsx(y,{placeholder:o?"Seleccionar amenidad":"Primero seleccione un parque"})}),e.jsxs(I,{children:[e.jsx(d,{value:"none",children:"Sin amenidad"}),he.map(a=>e.jsx(d,{value:String(a.id),children:a.name||a.moduleName||a.amenityName||`Amenidad ${a.id}`},a.id))]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{children:"Estado"}),e.jsxs(S,{value:se,onValueChange:te,children:[e.jsx(C,{children:e.jsx(y,{placeholder:"Seleccionar estado"})}),e.jsx(I,{children:Ne.map(a=>e.jsx(d,{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Condición"}),e.jsxs(S,{value:ie,onValueChange:ne,children:[e.jsx(C,{children:e.jsx(y,{placeholder:"Seleccionar condición"})}),e.jsx(I,{children:be.map(a=>e.jsx(d,{value:a.value,children:a.label},a.value))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"cost",children:"Costo de Adquisición"}),e.jsx(p,{id:"cost",type:"number",step:"0.01",value:E,onChange:a=>ae(a.target.value),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"acquisitionDate",children:"Fecha de Adquisición"}),e.jsx(p,{id:"acquisitionDate",type:"date",value:ce,onChange:a=>q(a.target.value)})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"location",children:"Descripción de Ubicación"}),e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(p,{id:"location",value:oe,onChange:a=>x(a.target.value),placeholder:j&&j!=="none"?"Se completó automáticamente desde la amenidad":"Descripción manual de la ubicación",className:"pl-10"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5 text-blue-600"}),e.jsx(n,{className:"text-lg font-medium",children:"Ubicación Geográfica"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"latitude",children:"Latitud"}),e.jsx(p,{id:"latitude",value:A,onChange:a=>L(a.target.value),onBlur:me,placeholder:"Ej: 19.432608"})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"longitude",children:"Longitud"}),e.jsx(p,{id:"longitude",value:$,onChange:a=>M(a.target.value),onBlur:me,placeholder:"Ej: -99.133209"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Mapa Interactivo"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Haz clic en el mapa para establecer la ubicación del activo"}),e.jsx("div",{className:"h-64 w-full border rounded-lg overflow-hidden",children:e.jsxs(Ve,{center:R,zoom:13,style:{height:"100%",width:"100%"},children:[e.jsx(Oe,{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(He,{position:je,setPosition:Ie})]},`${R[0]}-${R[1]}`)})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"notes",children:"Notas"}),e.jsx(pe,{id:"notes",value:Z,onChange:a=>ee(a.target.value),placeholder:"Notas adicionales sobre el activo",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4",children:[e.jsx(B,{variant:"outline",onClick:()=>f(`/admin/assets/${l}`),children:"Cancelar"}),e.jsx(B,{onClick:ke,disabled:U,children:U?"Guardando...":e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"Guardar Cambios"]})})]})]})]})]})})}export{Ye as default};
