import{al as oe,e as ce,a6 as de,Y as p,a8 as R,u as S,R as H,j as e,aB as he,B as m,b4 as me,aW as K,C as V,a as z,b as G,a3 as xe,c as O,Z as ue,I as je,z as T,H as E,J as k,K as q,N as i,au as ge,ba as pe,bb as ve,bc as Q,bd as o,be,bf as c,b0 as Ne,M as fe,ah as ye,f as v,x as U,an as we,l as Ce,X as Pe}from"./index-BBGHPKhn.js";import{H as Se}from"./Helmet-BYWrx2TX.js";import{P as Te,a as Ee,b as t,c as ke,d as b,f as J,e as qe}from"./pagination-CzVsvTQG.js";import{S as N}from"./skeleton-DR_YLL_-.js";import{T as W}from"./tree-deciduous-Btug09xw.js";import{L as Fe}from"./loader-circle-vbPEwN9U.js";import{C as Ie}from"./circle-check-CKc5skab.js";import"./ellipsis-DJvwf0dh.js";function Ke(){var $,A,D;const[,F]=oe(),{toast:h}=ce(),I=de(),[a,f]=p.useState(1),[x,X]=p.useState(""),[u,Y]=p.useState("all"),[j,Z]=p.useState("all"),[g,_]=p.useState("all"),y=R({mutationFn:async()=>{const s=await fetch("/api/tree-inventory/generate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("directToken")}`},body:JSON.stringify({})});if(!s.ok)throw new Error("Error al generar inventario");return await s.json()},onSuccess:s=>{var n;h({title:"Inventario generado exitosamente",description:`Se han generado árboles automáticamente para todos los parques. ${((n=s.stats)==null?void 0:n.totalTrees)||""} árboles totales.`}),I.invalidateQueries({queryKey:["/api/trees"]})},onError:s=>{h({title:"Error",description:s.message,variant:"destructive"})}}),{data:w,isLoading:ee}=S({queryKey:["/api/parks"],queryFn:async()=>{const s=await fetch("/api/parks");if(!s.ok)throw new Error("Error al cargar los parques");return s.json()}}),{data:C,isLoading:se}=S({queryKey:["/api/tree-species"],queryFn:async()=>{const s=await fetch("/api/tree-species");if(!s.ok)throw new Error("Error al cargar las especies arbóreas");return s.json()}}),{data:r,isLoading:ae,error:L}=S({queryKey:["/api/trees",a,x,u,j,g],queryFn:async()=>{let s=`/api/trees?page=${a}&limit=10`;x&&(s+=`&search=${encodeURIComponent(x)}`),u!=="all"&&(s+=`&parkId=${u}`),j!=="all"&&(s+=`&healthStatus=${j}`),g!=="all"&&(s+=`&speciesId=${g}`);const n=await fetch(s);if(!n.ok)throw new Error("Error al cargar el inventario de árboles");return n.json()}});H.useEffect(()=>{L&&h({title:"Error",description:"No se pudo cargar el inventario de árboles. Por favor, intenta nuevamente.",variant:"destructive"})},[L,h]);const M=()=>{F("/admin/trees/inventory/new")},P=R({mutationFn:async()=>ye("/api/trees/delete-all",{method:"DELETE"}),onSuccess:s=>{h({title:"Inventario limpiado",description:s.message||"Todos los árboles han sido eliminados del inventario"}),I.invalidateQueries({queryKey:["/api/trees"]})},onError:s=>{h({title:"Error al limpiar inventario",description:s.message||"No se pudieron eliminar todos los árboles",variant:"destructive"})}}),re=()=>{window.confirm(`¿Estás seguro de que deseas eliminar TODOS los árboles del inventario?

Esta acción eliminará todos los registros de árboles y sus mantenimientos asociados.

Esta acción no se puede deshacer.`)&&P.mutate()},B=s=>{F(`/admin/trees/inventory/${s}`)},d=s=>{f(s)},ne=s=>{s.preventDefault(),f(1)};H.useEffect(()=>{f(1)},[x,u,j,g]);const ie=s=>{switch(s.toLowerCase()){case"bueno":return e.jsxs(v,{variant:"outline",className:"bg-green-50 text-green-700 hover:bg-green-100",children:[e.jsx(Ie,{className:"h-3 w-3 mr-1"})," Bueno"]});case"regular":return e.jsxs(v,{variant:"outline",className:"bg-yellow-50 text-yellow-700 hover:bg-yellow-100",children:[e.jsx(we,{className:"h-3 w-3 mr-1"})," Regular"]});case"malo":return e.jsxs(v,{variant:"outline",className:"bg-orange-50 text-orange-700 hover:bg-orange-100",children:[e.jsx(U,{className:"h-3 w-3 mr-1"})," Malo"]});case"crítico":return e.jsxs(v,{variant:"destructive",children:[e.jsx(U,{className:"h-3 w-3 mr-1"})," Crítico"]});default:return e.jsx(v,{variant:"outline",children:s})}},te=s=>{if(!s)return"No disponible";try{return Ce(new Date(s),"dd/MM/yyyy",{locale:Pe})}catch{return"Fecha inválida"}},le=r&&r.data&&r.data.length>0,l=(($=r==null?void 0:r.pagination)==null?void 0:$.totalPages)||1;return e.jsxs(he,{children:[e.jsxs(Se,{children:[e.jsx("title",{children:"Inventario de Árboles | Bosques Urbanos"}),e.jsx("meta",{name:"description",content:"Gestión del inventario de árboles en los parques municipales"})]}),e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-green-800 flex items-center",children:[e.jsx(W,{className:"mr-2 h-8 w-8"}),"Inventario de Árboles"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Gestión y seguimiento de árboles individuales en los parques"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{onClick:re,variant:"outline",className:"border-red-600 text-red-600 hover:bg-red-50",disabled:P.isPending,children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),P.isPending?"Limpiando...":"Limpiar Inventario"]}),e.jsxs(m,{onClick:M,className:"bg-green-600 hover:bg-green-700 flex items-center",children:[e.jsx(K,{className:"mr-2 h-4 w-4"})," Agregar Árbol"]})]})]}),e.jsxs(V,{className:"mb-6",children:[e.jsxs(z,{className:"pb-3",children:[e.jsx(G,{children:"Filtros de Búsqueda"}),e.jsx(xe,{children:"Utiliza los filtros para encontrar árboles específicos"})]}),e.jsx(O,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("form",{onSubmit:ne,className:"md:col-span-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"}),e.jsx(je,{type:"search",placeholder:"Buscar por código o descripción...",className:"pl-9",value:x,onChange:s=>X(s.target.value)})]})}),e.jsx("div",{children:e.jsxs(T,{value:u,onValueChange:Y,children:[e.jsx(E,{children:e.jsx(k,{placeholder:"Filtrar por parque"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"Todos los parques"}),!ee&&(w==null?void 0:w.map(s=>e.jsx(i,{value:s.id.toString(),children:s.name},s.id)))]})]})}),e.jsx("div",{children:e.jsxs(T,{value:g,onValueChange:_,children:[e.jsx(E,{children:e.jsx(k,{placeholder:"Filtrar por especie"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"Todas las especies"}),!se&&((A=C==null?void 0:C.data)==null?void 0:A.map(s=>e.jsx(i,{value:s.id.toString(),children:s.commonName},s.id)))]})]})}),e.jsx("div",{children:e.jsxs(T,{value:j,onValueChange:Z,children:[e.jsx(E,{children:e.jsx(k,{placeholder:"Filtrar por estado"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"Todos los estados"}),e.jsx(i,{value:"Bueno",children:"Bueno"}),e.jsx(i,{value:"Regular",children:"Regular"}),e.jsx(i,{value:"Malo",children:"Malo"}),e.jsx(i,{value:"Crítico",children:"Crítico"})]})]})})]})})]}),e.jsxs(V,{children:[e.jsx(z,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(G,{children:"Listado de Árboles"}),e.jsxs("div",{className:"flex items-center gap-3",children:[r&&e.jsx("div",{className:"text-sm text-gray-500",children:r.pagination?e.jsxs(e.Fragment,{children:["Página ",r.pagination.page," de ",r.pagination.totalPages," - Mostrando ",(r.pagination.page-1)*10+1,"-",Math.min(r.pagination.page*10,r.pagination.total)," de ",r.pagination.total," árboles"]}):e.jsxs(e.Fragment,{children:["Total: ",r.total||((D=r.data)==null?void 0:D.length)||0," árboles"]})}),e.jsx(m,{onClick:()=>y.mutate(),disabled:y.isPending,className:"bg-green-600 hover:bg-green-700 text-white",children:y.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"mr-2 h-4 w-4 animate-spin"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Generar Inventario Automático"]})})]})]})}),e.jsx(O,{children:ae?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(N,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"h-4 w-[250px]"}),e.jsx(N,{className:"h-4 w-[200px]"})]})]}),e.jsx(N,{className:"h-[400px] w-full"})]}):le?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsxs(pe,{children:[e.jsx(ve,{children:e.jsxs(Q,{children:[e.jsx(o,{className:"w-[80px]",children:"Código"}),e.jsx(o,{children:"Especie"}),e.jsx(o,{children:"Parque"}),e.jsx(o,{children:"Estado"}),e.jsx(o,{children:"Altura (m)"}),e.jsx(o,{children:"DAP (cm)"}),e.jsx(o,{children:"Última Inspección"}),e.jsx(o,{children:"Acciones"})]})}),e.jsx(be,{children:r.data.map(s=>e.jsxs(Q,{className:"cursor-pointer hover:bg-gray-50",onClick:()=>B(s.id),children:[e.jsx(c,{className:"font-medium",children:s.code}),e.jsxs(c,{children:[e.jsx("div",{className:"font-medium",children:s.speciesName}),e.jsx("div",{className:"text-sm text-gray-500 italic",children:s.scientificName})]}),e.jsx(c,{children:s.parkName}),e.jsx(c,{children:ie(s.healthStatus)}),e.jsx(c,{children:s.height?`${s.height} m`:"-"}),e.jsx(c,{children:s.diameter?`${s.diameter} cm`:"-"}),e.jsx(c,{children:te(s.lastInspectionDate)}),e.jsx(c,{children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(m,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),B(s.id)},className:"text-green-600 hover:text-green-800 hover:bg-green-50",children:[e.jsx(Ne,{className:"h-4 w-4 mr-1"})," Ver"]}),e.jsxs(m,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),window.open(`https://www.google.com/maps/search/?api=1&query=${s.latitude},${s.longitude}`,"_blank")},className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50",children:[e.jsx(fe,{className:"h-4 w-4 mr-1"})," Mapa"]})]})})]},s.id))})]})}),l>1&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(Te,{children:e.jsxs(Ee,{children:[e.jsx(t,{children:e.jsx(ke,{onClick:()=>d(Math.max(1,a-1)),disabled:a===1})}),a>2&&e.jsx(t,{children:e.jsx(b,{onClick:()=>d(1),children:"1"})}),a>3&&e.jsx(t,{children:e.jsx(J,{})}),a>1&&e.jsx(t,{children:e.jsx(b,{onClick:()=>d(a-1),children:a-1})}),e.jsx(t,{children:e.jsx(b,{isActive:!0,onClick:()=>d(a),children:a})}),a<l&&e.jsx(t,{children:e.jsx(b,{onClick:()=>d(a+1),children:a+1})}),a<l-2&&e.jsx(t,{children:e.jsx(J,{})}),a<l-1&&e.jsx(t,{children:e.jsx(b,{onClick:()=>d(l),children:l})}),e.jsx(t,{children:e.jsx(qe,{onClick:()=>d(Math.min(l,a+1)),disabled:a===l})})]})})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(W,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No se encontraron árboles"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"No hay árboles registrados que coincidan con los criterios de búsqueda. Prueba a cambiar los filtros o agrega un nuevo árbol al inventario."}),e.jsxs(m,{onClick:M,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(K,{className:"mr-2 h-4 w-4"})," Agregar Árbol"]})]})})]})]})]})}export{Ke as default};
