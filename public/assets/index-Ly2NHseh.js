import{am as oe,e as ce,a6 as de,Y as p,a8 as R,u as S,R as H,j as e,aI as he,B as x,bb as xe,b2 as K,C as V,a as z,b as G,a3 as me,c as O,Z as ue,I as je,z as T,H as k,J as E,K as q,N as i,cA as ge,aB as pe,bh as ve,bi as be,bj as Q,bk as o,bl as Ne,bm as c,b7 as ye,M as fe,cs as we,ct as Ce,cv as t,cu as Pe,cw as v,ds as U,cx as Se,ai as Te,f as b,x as J,ao as ke,l as Ee,X as qe}from"./index-VG22aPDC.js";import{H as Fe}from"./Helmet-CoO02W0T.js";import{S as N}from"./skeleton-BEdbCltD.js";import{T as X}from"./tree-deciduous-BRCkX328.js";import{C as Ie}from"./circle-check-B0Aa9c5g.js";function De(){var A,$,D;const[,F]=oe(),{toast:h}=ce(),I=de(),[a,y]=p.useState(1),[m,Y]=p.useState(""),[u,Z]=p.useState("all"),[j,_]=p.useState("all"),[g,W]=p.useState("all"),f=R({mutationFn:async()=>{const s=await fetch("/api/tree-inventory/generate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("directToken")}`},body:JSON.stringify({})});if(!s.ok)throw new Error("Error al generar inventario");return await s.json()},onSuccess:s=>{var n;h({title:"Inventario generado exitosamente",description:`Se han generado árboles automáticamente para todos los parques. ${((n=s.stats)==null?void 0:n.totalTrees)||""} árboles totales.`}),I.invalidateQueries({queryKey:["/api/trees"]})},onError:s=>{h({title:"Error",description:s.message,variant:"destructive"})}}),{data:w,isLoading:ee}=S({queryKey:["/api/parks"],queryFn:async()=>{const s=await fetch("/api/parks");if(!s.ok)throw new Error("Error al cargar los parques");return s.json()}}),{data:C,isLoading:se}=S({queryKey:["/api/tree-species"],queryFn:async()=>{const s=await fetch("/api/tree-species");if(!s.ok)throw new Error("Error al cargar las especies arbóreas");return s.json()}}),{data:r,isLoading:ae,error:L}=S({queryKey:["/api/trees",a,m,u,j,g],queryFn:async()=>{let s=`/api/trees?page=${a}&limit=10`;m&&(s+=`&search=${encodeURIComponent(m)}`),u!=="all"&&(s+=`&parkId=${u}`),j!=="all"&&(s+=`&healthStatus=${j}`),g!=="all"&&(s+=`&speciesId=${g}`);const n=await fetch(s);if(!n.ok)throw new Error("Error al cargar el inventario de árboles");return n.json()}});H.useEffect(()=>{L&&h({title:"Error",description:"No se pudo cargar el inventario de árboles. Por favor, intenta nuevamente.",variant:"destructive"})},[L,h]);const M=()=>{F("/admin/trees/inventory/new")},P=R({mutationFn:async()=>Te("/api/trees/delete-all",{method:"DELETE"}),onSuccess:s=>{h({title:"Inventario limpiado",description:s.message||"Todos los árboles han sido eliminados del inventario"}),I.invalidateQueries({queryKey:["/api/trees"]})},onError:s=>{h({title:"Error al limpiar inventario",description:s.message||"No se pudieron eliminar todos los árboles",variant:"destructive"})}}),re=()=>{window.confirm(`¿Estás seguro de que deseas eliminar TODOS los árboles del inventario?

Esta acción eliminará todos los registros de árboles y sus mantenimientos asociados.

Esta acción no se puede deshacer.`)&&P.mutate()},B=s=>{F(`/admin/trees/inventory/${s}`)},d=s=>{y(s)},ne=s=>{s.preventDefault(),y(1)};H.useEffect(()=>{y(1)},[m,u,j,g]);const ie=s=>{switch(s.toLowerCase()){case"bueno":return e.jsxs(b,{variant:"outline",className:"bg-green-50 text-green-700 hover:bg-green-100",children:[e.jsx(Ie,{className:"h-3 w-3 mr-1"})," Bueno"]});case"regular":return e.jsxs(b,{variant:"outline",className:"bg-yellow-50 text-yellow-700 hover:bg-yellow-100",children:[e.jsx(ke,{className:"h-3 w-3 mr-1"})," Regular"]});case"malo":return e.jsxs(b,{variant:"outline",className:"bg-orange-50 text-orange-700 hover:bg-orange-100",children:[e.jsx(J,{className:"h-3 w-3 mr-1"})," Malo"]});case"crítico":return e.jsxs(b,{variant:"destructive",children:[e.jsx(J,{className:"h-3 w-3 mr-1"})," Crítico"]});default:return e.jsx(b,{variant:"outline",children:s})}},te=s=>{if(!s)return"No disponible";try{return Ee(new Date(s),"dd/MM/yyyy",{locale:qe})}catch{return"Fecha inválida"}},le=r&&r.data&&r.data.length>0,l=((A=r==null?void 0:r.pagination)==null?void 0:A.totalPages)||1;return e.jsxs(he,{children:[e.jsxs(Fe,{children:[e.jsx("title",{children:"Inventario de Árboles | Bosques Urbanos"}),e.jsx("meta",{name:"description",content:"Gestión del inventario de árboles en los parques municipales"})]}),e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-green-800 flex items-center",children:[e.jsx(X,{className:"mr-2 h-8 w-8"}),"Inventario de Árboles"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Gestión y seguimiento de árboles individuales en los parques"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{onClick:re,variant:"outline",className:"border-red-600 text-red-600 hover:bg-red-50",disabled:P.isPending,children:[e.jsx(xe,{className:"mr-2 h-4 w-4"}),P.isPending?"Limpiando...":"Limpiar Inventario"]}),e.jsxs(x,{onClick:M,className:"bg-green-600 hover:bg-green-700 flex items-center",children:[e.jsx(K,{className:"mr-2 h-4 w-4"})," Agregar Árbol"]})]})]}),e.jsxs(V,{className:"mb-6",children:[e.jsxs(z,{className:"pb-3",children:[e.jsx(G,{children:"Filtros de Búsqueda"}),e.jsx(me,{children:"Utiliza los filtros para encontrar árboles específicos"})]}),e.jsx(O,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("form",{onSubmit:ne,className:"md:col-span-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500"}),e.jsx(je,{type:"search",placeholder:"Buscar por código o descripción...",className:"pl-9",value:m,onChange:s=>Y(s.target.value)})]})}),e.jsx("div",{children:e.jsxs(T,{value:u,onValueChange:Z,children:[e.jsx(k,{children:e.jsx(E,{placeholder:"Filtrar por parque"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"Todos los parques"}),!ee&&(w==null?void 0:w.map(s=>e.jsx(i,{value:s.id.toString(),children:s.name},s.id)))]})]})}),e.jsx("div",{children:e.jsxs(T,{value:g,onValueChange:W,children:[e.jsx(k,{children:e.jsx(E,{placeholder:"Filtrar por especie"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"Todas las especies"}),!se&&(($=C==null?void 0:C.data)==null?void 0:$.map(s=>e.jsx(i,{value:s.id.toString(),children:s.commonName},s.id)))]})]})}),e.jsx("div",{children:e.jsxs(T,{value:j,onValueChange:_,children:[e.jsx(k,{children:e.jsx(E,{placeholder:"Filtrar por estado"})}),e.jsxs(q,{children:[e.jsx(i,{value:"all",children:"Todos los estados"}),e.jsx(i,{value:"Bueno",children:"Bueno"}),e.jsx(i,{value:"Regular",children:"Regular"}),e.jsx(i,{value:"Malo",children:"Malo"}),e.jsx(i,{value:"Crítico",children:"Crítico"})]})]})})]})})]}),e.jsxs(V,{children:[e.jsx(z,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(G,{children:"Listado de Árboles"}),e.jsxs("div",{className:"flex items-center gap-3",children:[r&&e.jsx("div",{className:"text-sm text-gray-500",children:r.pagination?e.jsxs(e.Fragment,{children:["Página ",r.pagination.page," de ",r.pagination.totalPages," - Mostrando ",(r.pagination.page-1)*10+1,"-",Math.min(r.pagination.page*10,r.pagination.total)," de ",r.pagination.total," árboles"]}):e.jsxs(e.Fragment,{children:["Total: ",r.total||((D=r.data)==null?void 0:D.length)||0," árboles"]})}),e.jsx(x,{onClick:()=>f.mutate(),disabled:f.isPending,className:"bg-green-600 hover:bg-green-700 text-white",children:f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"mr-2 h-4 w-4 animate-spin"}),"Generando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),"Generar Inventario Automático"]})})]})]})}),e.jsx(O,{children:ae?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(N,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"h-4 w-[250px]"}),e.jsx(N,{className:"h-4 w-[200px]"})]})]}),e.jsx(N,{className:"h-[400px] w-full"})]}):le?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsxs(ve,{children:[e.jsx(be,{children:e.jsxs(Q,{children:[e.jsx(o,{className:"w-[80px]",children:"Código"}),e.jsx(o,{children:"Especie"}),e.jsx(o,{children:"Parque"}),e.jsx(o,{children:"Estado"}),e.jsx(o,{children:"Altura (m)"}),e.jsx(o,{children:"DAP (cm)"}),e.jsx(o,{children:"Última Inspección"}),e.jsx(o,{children:"Acciones"})]})}),e.jsx(Ne,{children:r.data.map(s=>e.jsxs(Q,{className:"cursor-pointer hover:bg-gray-50",onClick:()=>B(s.id),children:[e.jsx(c,{className:"font-medium",children:s.code}),e.jsxs(c,{children:[e.jsx("div",{className:"font-medium",children:s.speciesName}),e.jsx("div",{className:"text-sm text-gray-500 italic",children:s.scientificName})]}),e.jsx(c,{children:s.parkName}),e.jsx(c,{children:ie(s.healthStatus)}),e.jsx(c,{children:s.height?`${s.height} m`:"-"}),e.jsx(c,{children:s.diameter?`${s.diameter} cm`:"-"}),e.jsx(c,{children:te(s.lastInspectionDate)}),e.jsx(c,{children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(x,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),B(s.id)},className:"text-green-600 hover:text-green-800 hover:bg-green-50",children:[e.jsx(ye,{className:"h-4 w-4 mr-1"})," Ver"]}),e.jsxs(x,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),window.open(`https://www.google.com/maps/search/?api=1&query=${s.latitude},${s.longitude}`,"_blank")},className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50",children:[e.jsx(fe,{className:"h-4 w-4 mr-1"})," Mapa"]})]})})]},s.id))})]})}),l>1&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(we,{children:e.jsxs(Ce,{children:[e.jsx(t,{children:e.jsx(Pe,{onClick:()=>d(Math.max(1,a-1)),disabled:a===1})}),a>2&&e.jsx(t,{children:e.jsx(v,{onClick:()=>d(1),children:"1"})}),a>3&&e.jsx(t,{children:e.jsx(U,{})}),a>1&&e.jsx(t,{children:e.jsx(v,{onClick:()=>d(a-1),children:a-1})}),e.jsx(t,{children:e.jsx(v,{isActive:!0,onClick:()=>d(a),children:a})}),a<l&&e.jsx(t,{children:e.jsx(v,{onClick:()=>d(a+1),children:a+1})}),a<l-2&&e.jsx(t,{children:e.jsx(U,{})}),a<l-1&&e.jsx(t,{children:e.jsx(v,{onClick:()=>d(l),children:l})}),e.jsx(t,{children:e.jsx(Se,{onClick:()=>d(Math.min(l,a+1)),disabled:a===l})})]})})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(X,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No se encontraron árboles"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"No hay árboles registrados que coincidan con los criterios de búsqueda. Prueba a cambiar los filtros o agrega un nuevo árbol al inventario."}),e.jsxs(x,{onClick:M,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(K,{className:"mr-2 h-4 w-4"})," Agregar Árbol"]})]})})]})]})]})}export{De as default};
