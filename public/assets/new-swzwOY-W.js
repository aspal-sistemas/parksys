import{d7 as R,d8 as K,d9 as l,da as j,db as p,dc as P,dd as U,de as Z,df as O,bT as de,bU as u,cX as f,dg as Q,dh as $,am as ue,e as me,a6 as xe,Y as L,a7 as he,ah as je,u as F,R as pe,a8 as ge,j as e,aI as ve,B as G,A as be,aa as Ne,C as M,a as D,b as w,bc as ye,a3 as k,c as V,ab as i,ac as r,ad as t,ae as o,I as m,af as c,z as C,H as S,J as I,K as A,N as h,O as ee,M as fe,aA as J,al as Ce,h as Se,bz as Ie,ai as Ae}from"./index-Dzu3mJf5.js";import{H as _e}from"./Helmet-BWphdh6I.js";import{L as ae,M as qe,T as Me,a as De}from"./leaflet-x_zWA9SN.js";import{a as we,u as Ve}from"./hooks-Cq82ihwg.js";const Le=R("asset_categories",{id:K("id").primaryKey(),name:l("name").notNull().unique(),description:l("description"),icon:l("icon"),color:l("color"),parentId:j("parent_id"),createdAt:p("created_at").notNull().defaultNow(),updatedAt:p("updated_at").notNull().defaultNow()}),Te=R("assets",{id:K("id").primaryKey(),name:l("name").notNull(),description:l("description"),serialNumber:l("serial_number"),categoryId:j("category_id").notNull(),parkId:j("park_id").notNull(),amenityId:j("amenity_id"),locationDescription:l("location_description"),latitude:l("latitude"),longitude:l("longitude"),acquisitionDate:P("acquisition_date"),acquisitionCost:U("acquisition_cost",{precision:10,scale:2}),currentValue:U("current_value",{precision:10,scale:2}),manufacturer:l("manufacturer"),model:l("model"),status:l("status").notNull().default("active"),condition:l("condition").notNull().default("good"),maintenanceFrequency:l("maintenance_frequency"),lastMaintenanceDate:P("last_maintenance_date"),nextMaintenanceDate:P("next_maintenance_date"),expectedLifespan:j("expected_lifespan"),notes:l("notes"),qrCode:l("qr_code"),responsiblePersonId:j("responsible_person_id"),photos:l("photos").array(),documents:l("documents").array(),createdAt:p("created_at").notNull().defaultNow(),updatedAt:p("updated_at").notNull().defaultNow()}),Ee=R("asset_maintenances",{id:K("id").primaryKey(),assetId:j("asset_id").notNull(),maintenanceType:l("maintenance_type").notNull(),date:P("date").notNull(),description:l("description").notNull(),estimatedCost:U("estimated_cost",{precision:10,scale:2}),actualCost:U("actual_cost",{precision:10,scale:2}),priority:l("priority").notNull().default("medium"),assignedToId:j("assigned_to_id"),notes:l("notes"),findings:l("findings"),actions:l("actions"),completionNotes:l("completion_notes"),photos:l("photos").array(),status:l("status").notNull().default("scheduled"),completedAt:p("completed_at"),createdAt:p("created_at").notNull().defaultNow(),updatedAt:p("updated_at").notNull().defaultNow()}),Fe=R("asset_history",{id:K("id").primaryKey(),assetId:j("asset_id").notNull(),changeType:l("change_type").notNull(),date:p("date").notNull().defaultNow(),description:l("description").notNull(),changedBy:j("changed_by").notNull(),previousValue:Z("previous_value"),newValue:Z("new_value"),notes:l("notes"),createdAt:p("created_at").notNull().defaultNow()});O(Le).omit({id:!0,createdAt:!0,updatedAt:!0});O(Te).omit({id:!0,createdAt:!0,updatedAt:!0});O(Ee).omit({id:!0,createdAt:!0,updatedAt:!0});O(Fe).omit({id:!0,createdAt:!0});const ke=[{value:"excellent",label:"Excelente"},{value:"good",label:"Bueno"},{value:"fair",label:"Regular"},{value:"poor",label:"Malo"}],Pe=[{value:"active",label:"Activo"},{value:"maintenance",label:"En Mantenimiento"},{value:"damaged",label:"Dañado"},{value:"retired",label:"Retirado"}],Ue=[{value:"daily",label:"Diario"},{value:"weekly",label:"Semanal"},{value:"monthly",label:"Mensual"},{value:"quarterly",label:"Trimestral"},{value:"biannual",label:"Semestral"},{value:"yearly",label:"Anual"}];delete ae.Icon.Default.prototype._getIconUrl;ae.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});const Re=de({name:u().min(1,"El nombre es obligatorio"),description:u().nullable().optional(),serialNumber:u().nullable().optional(),categoryId:f().min(1,"La categoría es obligatoria"),parkId:f().min(1,"El parque es obligatorio"),amenityId:f().nullable().optional(),locationDescription:u().nullable().optional(),latitude:u().nullable().optional(),longitude:u().nullable().optional(),acquisitionDate:u().nullable().optional(),acquisitionCost:Q([f().positive(),$()]).transform(d=>isNaN(d)?null:d).nullable().optional(),currentValue:Q([f().positive(),$()]).transform(d=>isNaN(d)?null:d).nullable().optional(),manufacturer:u().nullable().optional(),model:u().nullable().optional(),status:u().min(1,"El estado es obligatorio"),condition:u().min(1,"La condición es obligatoria"),maintenanceFrequency:u().nullable().optional(),lastMaintenanceDate:u().nullable().optional(),nextMaintenanceDate:u().nullable().optional(),expectedLifespan:Q([f().positive(),$()]).transform(d=>isNaN(d)?null:d).nullable().optional(),notes:u().nullable().optional(),qrCode:u().nullable().optional(),responsiblePersonId:f().nullable().optional()});function Ke({center:d}){const v=we();return L.useEffect(()=>{d&&v.setView(d,16)},[d,v]),null}function Oe({position:d,onLocationSelect:v}){return Ve({click(_){v(_.latlng.lat,_.latlng.lng)}}),d?e.jsx(De,{position:d}):null}const Je=()=>{const[d,v]=ue(),{toast:_}=me(),X=xe(),[z,ne]=L.useState(null),[T,Y]=L.useState(null),s=he({resolver:je(Re),defaultValues:{name:"",description:"",serialNumber:"",categoryId:0,parkId:0,amenityId:null,locationDescription:"",latitude:"",longitude:"",acquisitionDate:new Date().toISOString().split("T")[0],acquisitionCost:null,currentValue:null,manufacturer:"",model:"",status:"active",condition:"good",maintenanceFrequency:null,lastMaintenanceDate:"",nextMaintenanceDate:"",expectedLifespan:null,notes:"",qrCode:"",responsiblePersonId:null}}),{data:b,isLoading:se}=F({queryKey:["/api/asset-categories/tree/structure"]}),E=pe.useMemo(()=>{if(!b)return[];const a=[];return b.forEach(n=>{a.push(n),n.children&&n.children.forEach(x=>{a.push(x)})}),a},[b]),le=a=>{if(!E||E.length===0)return"";const n=E.find(x=>x.id===a);if(!n)return"";if(n.parentId){const x=E.find(ce=>ce.id===n.parentId);return x?`${x.name} → ${n.name}`:n.name}return n.name},{data:g,isLoading:te}=F({queryKey:["/api/parks"]}),N=s.watch("parkId"),{data:y,isLoading:ze}=F({queryKey:[`/api/parks/${N}/amenities`],enabled:!!N&&N>0}),{data:B,isLoading:Be}=F({queryKey:["/api/users"]});L.useEffect(()=>{if(N&&N>0&&(s.setValue("amenityId",null),s.setValue("locationDescription",""),g&&Array.isArray(g))){const a=g.find(n=>n.id===N);if(a&&a.latitude&&a.longitude){const n=[parseFloat(a.latitude),parseFloat(a.longitude)];ne(n),Y(null),s.setValue("latitude",""),s.setValue("longitude","")}}},[N,s,g]);const ie=(a,n)=>{Y([a,n]),s.setValue("latitude",a.toString()),s.setValue("longitude",n.toString())},q=s.watch("amenityId");L.useEffect(()=>{if(q&&q!==null&&y&&Array.isArray(y)){const a=y.find(n=>n.id===q);if(a){const n=a.moduleName?`${a.amenityName} - ${a.moduleName}`:a.amenityName;s.setValue("locationDescription",n||"")}}else q===null&&s.setValue("locationDescription","")},[q,y,s]);const H=ge({mutationFn:a=>Ae("/api/assets-direct",{method:"POST",data:a}),onSuccess:a=>{X.invalidateQueries({queryKey:["/api/assets"]}),X.invalidateQueries({queryKey:["/api/asset-categories"]}),_({title:"Activo creado",description:"El activo se ha creado correctamente."}),v("/admin/assets")},onError:a=>{_({title:"Error",description:"Ha ocurrido un error al crear el activo.",variant:"destructive"}),console.error("Error al crear activo:",a)}}),W=()=>{v("/admin/assets")},re=a=>{H.mutate(a)},oe=!se&&!te&&b&&g;return e.jsxs(ve,{children:[e.jsxs(_e,{children:[e.jsx("title",{children:"Crear Nuevo Activo | Bosques Urbanos"}),e.jsx("meta",{name:"description",content:"Formulario para registrar un nuevo activo en el sistema."})]}),e.jsx("div",{className:"flex justify-between items-center mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs(G,{variant:"outline",onClick:W,className:"mr-4",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Volver"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Crear Nuevo Activo"}),e.jsx("p",{className:"text-muted-foreground",children:"Complete el formulario para registrar un nuevo activo en el sistema."})]})]})}),oe?e.jsx(Ne,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(re),className:"space-y-6",children:[e.jsxs(M,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5"}),"Información Básica"]}),e.jsx(k,{children:"Información general del activo"})]}),e.jsxs(V,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"name",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Nombre*"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Nombre del activo",...a})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"serialNumber",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Número de Serie"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Número de serie o código",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"categoryId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Categoría*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>a.onChange(parseInt(n)),children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione una categoría"})}),e.jsx(A,{children:b&&Array.isArray(b)?b.map(n=>[e.jsx(h,{value:n.id.toString(),children:e.jsx("span",{className:"font-semibold text-gray-900",children:n.name})},n.id),...n.children&&n.children.length>0?n.children.map(x=>e.jsx(h,{value:x.id.toString(),children:e.jsxs("span",{className:"text-gray-600 ml-4",children:["↳ ",x.name]})},x.id)):[]]).flat():null})]})}),a.value&&a.value>0&&e.jsxs("div",{className:"text-sm text-gray-600 mt-2 p-2 bg-gray-50 rounded-md",children:[e.jsx("span",{className:"font-medium",children:"Categoría seleccionada:"})," ",le(a.value)]}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"manufacturer",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Fabricante"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Marca o fabricante",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"model",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Modelo"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Modelo del activo",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"status",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Estado*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value,onValueChange:a.onChange,children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione un estado"})}),e.jsx(A,{children:Pe.map(n=>e.jsx(h,{value:n.value,children:n.label},n.value))})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"condition",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Condición*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value,onValueChange:a.onChange,children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione una condición"})}),e.jsx(A,{children:ke.map(n=>e.jsx(h,{value:n.value,children:n.label},n.value))})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"qrCode",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Código QR"}),e.jsx(o,{children:e.jsx(m,{placeholder:"URL o código QR",...a,value:a.value||""})}),e.jsx(c,{})]})})]}),e.jsx("div",{className:"mt-4",children:e.jsx(i,{control:s.control,name:"description",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Descripción"}),e.jsx(o,{children:e.jsx(ee,{placeholder:"Descripción detallada del activo",...a,value:a.value||""})}),e.jsx(c,{})]})})})]})]}),e.jsxs(M,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5"}),"Ubicación"]}),e.jsx(k,{children:"Ubicación física del activo"})]}),e.jsx(V,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"parkId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Parque*"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>{const x=parseInt(n);a.onChange(x),s.setValue("amenityId",null),s.setValue("locationDescription","")},children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione un parque"})}),e.jsx(A,{children:g&&Array.isArray(g)?g.map(n=>e.jsx(h,{value:n.id.toString(),children:n.name},n.id)):null})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"amenityId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Amenidad (Opcional)"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>{n===""||n==="none"?a.onChange(null):a.onChange(parseInt(n))},children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione una amenidad"})}),e.jsxs(A,{className:"z-[1001]",children:[e.jsx(h,{value:"none",children:"Sin amenidad específica"}),y&&Array.isArray(y)?y.filter(n=>n.id&&n.amenityName).map(n=>e.jsxs(h,{value:n.id.toString(),children:[n.amenityName," - ",n.moduleName||"Módulo general"]},n.id)):null]})]})}),e.jsx(J,{children:"Si se selecciona, la ubicación se llenará automáticamente"}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"locationDescription",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Descripción de Ubicación"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Ubicación específica dentro del parque",...a,value:a.value||""})}),e.jsx(J,{children:"Se llena automáticamente si selecciona una amenidad"}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"responsiblePersonId",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Responsable"}),e.jsx(o,{children:e.jsxs(C,{value:a.value?a.value.toString():"",onValueChange:n=>a.onChange(n?parseInt(n):null),children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione un responsable"})}),e.jsxs(A,{className:"z-[1001]",children:[e.jsx(h,{value:"none",children:"Sin responsable asignado"}),B&&Array.isArray(B)?B.map(n=>e.jsxs(h,{value:n.id.toString(),children:[n.username," (",n.role,")"]},n.id)):null]})]})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"latitude",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Latitud"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Coordenada de latitud",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"longitude",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Longitud"}),e.jsx(o,{children:e.jsx(m,{placeholder:"Coordenada de longitud",...a,value:a.value||""})}),e.jsx(c,{})]})}),z&&e.jsxs("div",{className:"col-span-2",children:[e.jsx(t,{children:"Ubicación en el mapa"}),e.jsx(J,{className:"mb-2",children:"Haz clic en el mapa para seleccionar la ubicación exacta del activo"}),e.jsx("div",{className:"h-64 w-full border rounded-md overflow-hidden",children:e.jsxs(qe,{center:z,zoom:16,style:{height:"100%",width:"100%"},children:[e.jsx(Me,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),e.jsx(Ke,{center:z}),e.jsx(Oe,{position:T,onLocationSelect:ie})]})}),T&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Ubicación seleccionada: ",T[0].toFixed(6),", ",T[1].toFixed(6)]})]})]})})]}),e.jsxs(M,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5"}),"Información Financiera"]}),e.jsx(k,{children:"Datos económicos y de valoración del activo"})]}),e.jsx(V,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"acquisitionDate",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Fecha de Adquisición"}),e.jsx(o,{children:e.jsx(m,{type:"date",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"expectedLifespan",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Vida Útil (meses)"}),e.jsx(o,{children:e.jsx(m,{type:"number",placeholder:"Vida útil esperada en meses",...a,value:a.value===null?"":a.value,onChange:n=>a.onChange(n.target.value===""?null:parseInt(n.target.value))})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"acquisitionCost",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Costo de Adquisición"}),e.jsx(o,{children:e.jsx(m,{type:"number",step:"0.01",placeholder:"Costo en pesos",...a,value:a.value===null?"":a.value,onChange:n=>a.onChange(n.target.value===""?null:parseFloat(n.target.value))})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"currentValue",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Valor Actual"}),e.jsx(o,{children:e.jsx(m,{type:"number",step:"0.01",placeholder:"Valor actual después de depreciación",...a,value:a.value===null?"":a.value,onChange:n=>a.onChange(n.target.value===""?null:parseFloat(n.target.value))})}),e.jsx(c,{})]})})]})})]}),e.jsxs(M,{children:[e.jsxs(D,{children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-5 w-5"}),"Mantenimiento"]}),e.jsx(k,{children:"Programación y seguimiento de mantenimiento"})]}),e.jsx(V,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(i,{control:s.control,name:"maintenanceFrequency",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Frecuencia de Mantenimiento"}),e.jsx(o,{children:e.jsxs(C,{value:a.value||"",onValueChange:n=>a.onChange(n||null),children:[e.jsx(S,{children:e.jsx(I,{placeholder:"Seleccione frecuencia"})}),e.jsxs(A,{children:[e.jsx(h,{value:"none",children:"Sin mantenimiento programado"}),Ue.map(n=>e.jsx(h,{value:n.value,children:n.label},n.value))]})]})}),e.jsx(c,{})]})}),e.jsx("div",{className:"md:col-span-1"}),e.jsx(i,{control:s.control,name:"lastMaintenanceDate",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Último Mantenimiento"}),e.jsx(o,{children:e.jsx(m,{type:"date",...a,value:a.value||""})}),e.jsx(c,{})]})}),e.jsx(i,{control:s.control,name:"nextMaintenanceDate",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Próximo Mantenimiento"}),e.jsx(o,{children:e.jsx(m,{type:"date",...a,value:a.value||""})}),e.jsx(c,{})]})})]})})]}),e.jsxs(M,{children:[e.jsx(D,{children:e.jsx(w,{children:"Notas Adicionales"})}),e.jsx(V,{children:e.jsx(i,{control:s.control,name:"notes",render:({field:a})=>e.jsxs(r,{children:[e.jsx(t,{children:"Notas"}),e.jsx(o,{children:e.jsx(ee,{placeholder:"Información adicional sobre el activo...",...a,value:a.value||"",rows:4})}),e.jsx(c,{})]})})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(G,{type:"button",variant:"outline",onClick:W,children:"Cancelar"}),e.jsxs(G,{type:"submit",className:"gap-1",disabled:H.isPending,children:[e.jsx(Ie,{className:"h-4 w-4"}),H.isPending?"Guardando...":"Guardar Activo"]})]})]})}):e.jsx("div",{className:"py-8 text-center text-muted-foreground",children:e.jsx("p",{children:"Cargando información necesaria..."})})]})};export{Je as default};
