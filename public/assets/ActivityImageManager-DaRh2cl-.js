import{a2 as g,l as T,ae as M,u as Q,ag as w,aq as U,j as e,f as x,g as y,h as S,bZ as B,ab as z,i as j,N as n,O as v,B as f,aR as o,b as I,X as K}from"./index-D5qLf1ib.js";import{S as V}from"./star-off-C3XMYBqW.js";const J=({activityId:s,onImageUploaded:C,showUploadOnly:E=!1})=>{const[d,F]=g.useState(null),[m,P]=g.useState(null),[u,b]=g.useState(""),p=g.useRef(null),{toast:r}=T(),N=M(),{data:l=[],isLoading:A}=Q({queryKey:[`/api/activities/${s}/images`],enabled:!!s&&!E}),c=w({mutationFn:async a=>{if(!s)throw new Error("ID de actividad requerido");const t=localStorage.getItem("token")||"direct-token-1750522117022",i=await fetch(`/api/activities/${s}/images`,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:a});if(!i.ok){const h=await i.text();throw new Error(`Error al subir imagen: ${i.status} ${h}`)}return await i.json()},onSuccess:a=>{r({title:"Imagen subida",description:"La imagen se ha subido exitosamente"}),F(null),P(null),b(""),p.current&&(p.current.value=""),N.invalidateQueries({queryKey:[`/api/activities/${s}/images`]}),C&&C(a)},onError:a=>{r({title:"Error",description:`No se pudo subir la imagen: ${a.message}`,variant:"destructive"})}}),$=w({mutationFn:async a=>await U(`/api/activities/${s}/images/${a}`,{method:"DELETE"}),onSuccess:()=>{r({title:"Imagen eliminada",description:"La imagen se ha eliminado exitosamente"}),N.invalidateQueries({queryKey:[`/api/activities/${s}/images`]})},onError:()=>{r({title:"Error",description:"No se pudo eliminar la imagen",variant:"destructive"})}}),k=w({mutationFn:async a=>{const t=localStorage.getItem("token")||"direct-token-1750522117022";if(!(await fetch(`/api/activities/${s}/images/${a}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({isPrimary:!0})})).ok)throw new Error("Error al establecer imagen principal")},onSuccess:()=>{r({title:"Imagen principal actualizada",description:"La imagen principal se ha actualizado exitosamente"}),N.invalidateQueries({queryKey:[`/api/activities/${s}/images`]})},onError:()=>{r({title:"Error",description:"No se pudo actualizar la imagen principal",variant:"destructive"})}}),D=a=>{var i;const t=(i=a.target.files)==null?void 0:i[0];if(t){F(t);const h=new FileReader;h.onload=R=>{var L;P((L=R.target)==null?void 0:L.result)},h.readAsDataURL(t)}},q=async()=>{if(!d){r({title:"Error",description:"Por favor selecciona una imagen",variant:"destructive"});return}const a=new FormData;a.append("image",d),u&&a.append("caption",u),c.mutate(a)};return E||!s?e.jsxs(x,{children:[e.jsxs(y,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5"}),"Subir Imagen"]}),e.jsx(z,{children:s?"Selecciona una imagen para la actividad":"Primero guarda la actividad para poder subir im치genes"})]}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"image-upload",children:"Seleccionar Imagen"}),e.jsx(v,{id:"image-upload",ref:p,type:"file",accept:"image/*",onChange:D,disabled:!s})]}),m&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Vista previa:"}),e.jsx("div",{className:"relative w-full h-48 border rounded-lg overflow-hidden",children:e.jsx("img",{src:m,alt:"Vista previa",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"caption",children:"Descripci칩n (opcional)"}),e.jsx(v,{id:"caption",value:u,onChange:a=>b(a.target.value),placeholder:"Describe la imagen...",disabled:!s})]}),e.jsx(f,{onClick:q,disabled:!d||!s||c.isPending,className:"w-full",children:c.isPending?e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"mr-2 h-4 w-4 animate-spin"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"mr-2 h-4 w-4"}),"Subir Imagen"]})})]})]}):A?e.jsx(x,{children:e.jsx(j,{className:"p-6",children:e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-[#00a587]"})})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(x,{children:[e.jsx(y,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(o,{className:"h-5 w-5"}),"Subir Nueva Imagen"]})}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"image-upload",children:"Seleccionar Imagen"}),e.jsx(v,{id:"image-upload",ref:p,type:"file",accept:"image/*",onChange:D})]}),m&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Vista previa:"}),e.jsx("div",{className:"relative w-full h-48 border rounded-lg overflow-hidden",children:e.jsx("img",{src:m,alt:"Vista previa",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"caption",children:"Descripci칩n (opcional)"}),e.jsx(v,{id:"caption",value:u,onChange:a=>b(a.target.value),placeholder:"Describe la imagen..."})]}),e.jsx(f,{onClick:q,disabled:!d||c.isPending,className:"w-full bg-[#00a587] hover:bg-[#067f5f]",children:c.isPending?e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"mr-2 h-4 w-4 animate-spin"}),"Subiendo..."]}):e.jsxs(e.Fragment,{children:[e.jsx(o,{className:"mr-2 h-4 w-4"}),"Subir Imagen"]})})]})]}),l.length>0&&e.jsxs(x,{children:[e.jsxs(y,{children:[e.jsx(S,{children:"Im치genes de la Actividad"}),e.jsxs(z,{children:[l.length," imagen",l.length!==1?"es":""," subida",l.length!==1?"s":""]})]}),e.jsx(j,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:l.map(a=>e.jsxs("div",{className:"relative group",children:[e.jsxs("div",{className:"relative aspect-video border rounded-lg overflow-hidden",children:[e.jsx("img",{src:a.imageUrl,alt:a.caption||"Imagen de actividad",className:"w-full h-full object-cover"}),a.isPrimary&&e.jsxs("div",{className:"absolute top-2 left-2 bg-yellow-500 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1",children:[e.jsx(I,{className:"h-3 w-3"}),"Principal"]}),e.jsxs("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1",children:[!a.isPrimary&&e.jsx(f,{size:"sm",variant:"secondary",onClick:()=>k.mutate(a.id),disabled:k.isPending,className:"h-8 w-8 p-0",children:e.jsx(V,{className:"h-4 w-4"})}),e.jsx(f,{size:"sm",variant:"destructive",onClick:()=>$.mutate(a.id),disabled:$.isPending,className:"h-8 w-8 p-0",children:e.jsx(K,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"mt-2 space-y-1",children:[a.caption&&e.jsx("p",{className:"text-sm text-gray-600 truncate",children:a.caption}),e.jsxs("p",{className:"text-xs text-gray-400",children:["Subida el ",new Date(a.createdAt).toLocaleDateString("es-ES")]})]})]},a.id))})})]})]})};export{J as A};
