import{a2 as W,u as _,j as e,aX as B,f,i as v,aW as k,B as g,D as J,g as L,h as T,a7 as Y,N as j,a4 as Z,O as ee,Q as N,V as y,W as b,Y as w,_ as i,e as C,o as S,ab as se,aB as ae,bH as re,bI as te,bJ as E,bK as n,bL as ie,bM as c,r as u,aM as le,aN as ne,cb as F,ax as H,ah as U,ar as ce,a5 as de,U as oe,bo as me,dX as xe,a1 as z}from"./index-D5qLf1ib.js";import{R as D}from"./RoleBadge-D5voYAx-.js";import"./gem-dXiyKzl3.js";const pe=()=>{const[r,V]=W.useState({search:"",action:"all",severity:"all",module:"all",fromDate:"",toDate:"",limit:50,offset:0}),{data:d,isLoading:A,error:q}=_({queryKey:["/api/audit/role-changes",r],queryFn:async()=>{const s=new URLSearchParams;Object.entries(r).forEach(([l,a])=>{a&&a!=="all"&&a!==""&&s.append(l,a.toString())});const t=await fetch(`/api/audit/role-changes?${s.toString()}`);if(!t.ok)throw new Error("Error al cargar logs de auditoría");return t.json()}}),{data:p}=_({queryKey:["/api/audit/modules"],queryFn:async()=>{const s=await fetch("/api/audit/modules");return s.ok?s.json():{data:[{value:"all",label:"Todos los módulos"}]}}}),R=(d==null?void 0:d.data)||[],m=(d==null?void 0:d.pagination)||{total:0,hasMore:!1},P=(p==null?void 0:p.data)||[{value:"all",label:"Todos los módulos"}],o=(s,t)=>{V(l=>({...l,[s]:t,offset:s!=="offset"?0:t}))},O=async()=>{try{const s=new URLSearchParams;Object.entries(r).forEach(([x,h])=>{h&&h!=="all"&&h!==""&&s.append(x,h.toString())}),s.append("limit","1000");const t=await fetch(`/api/audit/role-changes?${s.toString()}`);if(!t.ok)throw new Error("Error al exportar datos");const l=await t.json(),a=$(l.data);K(a,`auditoria-roles-${u(new Date,"yyyy-MM-dd")}.csv`),F({title:"Exportación exitosa",description:"Los datos de auditoría se han exportado correctamente"})}catch{F({title:"Error de exportación",description:"No se pudo exportar los datos de auditoría",variant:"destructive"})}},$=s=>{const t=["Fecha","Acción","Usuario","Módulo","Descripción","Severidad","Realizado por"],l=s.map(a=>[u(new Date(a.timestamp),"yyyy-MM-dd HH:mm:ss"),I(a.action),a.username||"Sistema",a.module,a.description,M(a.severity),a.performedBy]);return[t,...l].map(a=>a.map(x=>`"${x}"`).join(",")).join(`
`)},K=(s,t)=>{const l=new Blob([s],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");if(a.download!==void 0){const x=URL.createObjectURL(l);a.setAttribute("href",x),a.setAttribute("download",t),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}},I=s=>({role_change:"Cambio de Rol",permission_granted:"Permiso Otorgado",permission_revoked:"Permiso Revocado",login_attempt:"Intento de Acceso",bulk_assignment:"Asignación Masiva",matrix_update:"Actualización Matriz"})[s]||s,X=s=>({low:"bg-green-100 text-green-800",medium:"bg-yellow-100 text-yellow-800",high:"bg-red-100 text-red-800"})[s]||"bg-gray-100 text-gray-800",M=s=>({low:"Baja",medium:"Media",high:"Alta"})[s]||s,G=s=>{switch(s){case"high":return e.jsx(k,{className:"w-4 h-4"});case"medium":return e.jsx(H,{className:"w-4 h-4"});case"low":return e.jsx(U,{className:"w-4 h-4"});default:return e.jsx(H,{className:"w-4 h-4"})}},Q=s=>{switch(s){case"role_change":return e.jsx(xe,{className:"w-4 h-4"});case"permission_granted":return e.jsx(U,{className:"w-4 h-4"});case"permission_revoked":return e.jsx(me,{className:"w-4 h-4"});case"login_attempt":return e.jsx(C,{className:"w-4 h-4"});case"bulk_assignment":return e.jsx(oe,{className:"w-4 h-4"});case"matrix_update":return e.jsx(de,{className:"w-4 h-4"});default:return e.jsx(ce,{className:"w-4 h-4"})}};return q?e.jsx(B,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Auditoría de Roles"}),e.jsx("p",{className:"text-muted-foreground",children:"Error al cargar los datos de auditoría"})]})}),e.jsx(f,{children:e.jsx(v,{className:"pt-6",children:e.jsxs("div",{className:"text-center text-red-600",children:[e.jsx(k,{className:"w-12 h-12 mx-auto mb-4"}),e.jsx("p",{children:"No se pudieron cargar los logs de auditoría."}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Verifique la conexión con el servidor."})]})})})]})}):e.jsx(B,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Auditoría de Roles"}),e.jsx("p",{className:"text-muted-foreground",children:"Registro completo de cambios en roles y permisos del sistema"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(g,{variant:"outline",onClick:O,disabled:A,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Exportar"]})})]}),e.jsxs(f,{children:[e.jsx(L,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),"Filtros de Búsqueda"]})}),e.jsx(v,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"search",children:"Búsqueda General"}),e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(ee,{id:"search",placeholder:"Buscar usuario, descripción...",value:r.search,onChange:s=>o("search",s.target.value),className:"pl-10"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"action",children:"Tipo de Acción"}),e.jsxs(N,{value:r.action,onValueChange:s=>o("action",s),children:[e.jsx(y,{children:e.jsx(b,{})}),e.jsxs(w,{children:[e.jsx(i,{value:"all",children:"Todas las acciones"}),e.jsx(i,{value:"role_change",children:"Cambios de rol"}),e.jsx(i,{value:"permission_granted",children:"Permisos otorgados"}),e.jsx(i,{value:"permission_revoked",children:"Permisos revocados"}),e.jsx(i,{value:"login_attempt",children:"Intentos de acceso"}),e.jsx(i,{value:"bulk_assignment",children:"Asignaciones masivas"}),e.jsx(i,{value:"matrix_update",children:"Actualizaciones matriz"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"severity",children:"Severidad"}),e.jsxs(N,{value:r.severity,onValueChange:s=>o("severity",s),children:[e.jsx(y,{children:e.jsx(b,{})}),e.jsxs(w,{children:[e.jsx(i,{value:"all",children:"Todas las severidades"}),e.jsx(i,{value:"high",children:"Alta"}),e.jsx(i,{value:"medium",children:"Media"}),e.jsx(i,{value:"low",children:"Baja"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"module",children:"Módulo"}),e.jsxs(N,{value:r.module,onValueChange:s=>o("module",s),children:[e.jsx(y,{children:e.jsx(b,{})}),e.jsx(w,{children:P.map(s=>e.jsx(i,{value:s.value,children:s.label},s.value))})]})]})]})})]}),e.jsxs(f,{children:[e.jsxs(L,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5"}),"Registro de Auditoría",m.total>0&&e.jsxs(S,{variant:"secondary",className:"ml-2",children:[m.total," registros"]})]}),e.jsx(se,{children:"Historial completo de actividades relacionadas con roles y permisos"})]}),e.jsx(v,{children:A?e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(ae,{className:"w-8 h-8 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Cargando logs de auditoría..."})]}):R.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(C,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No hay registros"}),e.jsx("p",{className:"text-muted-foreground",children:"No se encontraron logs de auditoría con los filtros seleccionados."})]}):e.jsxs(e.Fragment,{children:[e.jsxs(re,{children:[e.jsx(te,{children:e.jsxs(E,{children:[e.jsx(n,{className:"w-[140px]",children:"Fecha/Hora"}),e.jsx(n,{children:"Acción"}),e.jsx(n,{children:"Usuario"}),e.jsx(n,{children:"Cambios"}),e.jsx(n,{children:"Módulo"}),e.jsx(n,{children:"Realizado por"}),e.jsx(n,{children:"Severidad"})]})}),e.jsx(ie,{children:R.map(s=>e.jsxs(E,{children:[e.jsx(c,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:u(new Date(s.timestamp),"dd/MM/yyyy",{locale:z})}),e.jsx("div",{className:"text-muted-foreground",children:u(new Date(s.timestamp),"HH:mm:ss",{locale:z})})]})}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[Q(s.action),e.jsx("span",{className:"font-medium",children:I(s.action)})]})}),e.jsx(c,{children:s.username?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.username}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["ID: ",s.userId]})]}):e.jsx("span",{className:"text-muted-foreground",children:"Sistema"})}),e.jsx(c,{className:"max-w-md",children:e.jsxs("div",{className:"space-y-1",children:[s.fromRoleId&&s.toRoleId&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(D,{roleId:s.fromRoleId}),e.jsx("span",{children:"→"}),e.jsx(D,{roleId:s.toRoleId})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.description})]})}),e.jsx(c,{children:e.jsx(S,{variant:"outline",children:s.module})}),e.jsx(c,{children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:s.performedBy}),s.performedById&&s.performedById>0&&e.jsxs("div",{className:"text-muted-foreground",children:["ID: ",s.performedById]})]})}),e.jsx(c,{children:e.jsx(S,{className:X(s.severity),children:e.jsxs("div",{className:"flex items-center gap-1",children:[G(s.severity),M(s.severity)]})})})]},s.id))})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Mostrando ",r.offset+1,"-",Math.min(r.offset+r.limit,m.total)," de ",m.total," registros"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>o("offset",Math.max(0,r.offset-r.limit)),disabled:r.offset===0,children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"Anterior"]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>o("offset",r.offset+r.limit),disabled:!m.hasMore,children:["Siguiente",e.jsx(ne,{className:"w-4 h-4 ml-1"})]})]})]})]})})]})]})})};export{pe as default};
