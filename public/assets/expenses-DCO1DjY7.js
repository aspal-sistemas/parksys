import{ce as de,cX as O,cf as y,a2 as c,l as me,u as E,af as X,ap as R,ag as P,j as e,aX as xe,w as M,x as ue,B as l,bh as he,y as L,z as A,I as z,J as K,ai as pe,aj as d,ak as m,al as x,Q as H,am as u,V as Y,W as $,Y as U,_ as W,an as h,O as t,aB as w,f as je,g as ge,h as ve,ab as ye,i as Ne,o as fe,bq as be,bn as Ce,ca as V}from"./index-D5qLf1ib.js";import{T as _}from"./trending-down-Bn0HnEog.js";const Z=de({parkId:O().min(1,"Debe seleccionar un parque"),categoryId:O().min(1,"Debe seleccionar una categoría"),concept:y().min(1,"El concepto es requerido"),amount:O().min(.01,"El monto debe ser mayor a 0"),description:y().min(1,"La descripción es requerida"),date:y().min(1,"La fecha es requerida"),vendor:y().optional(),notes:y().optional()}),De=()=>{const[ee,S]=c.useState(!1),[r,i]=c.useState(null),[se,N]=c.useState(!1),[ae,f]=c.useState(!1),[p,D]=c.useState(null),[n,j]=c.useState({concept:"",year:"",month:"",date:"",category:""}),{toast:g}=me(),{data:b=[],isLoading:re}=E({queryKey:["/api/actual-expenses"]}),{data:I=[],isLoading:Ee}=E({queryKey:["/api/payroll-expenses"]}),{data:C=[]}=E({queryKey:["/api/expense-categories"]}),{data:T=[]}=E({queryKey:["/api/parks"]}),o=X({resolver:R(Z),defaultValues:{parkId:3,categoryId:2,concept:"",amount:0,description:"",date:new Date().toISOString().split("T")[0],vendor:"",notes:""}}),ne=X({resolver:R(Z),defaultValues:{parkId:3,categoryId:2,concept:"",amount:0,description:"",date:new Date().toISOString().split("T")[0],vendor:"",notes:""}}),k=P({mutationFn:async s=>{const a=await fetch("/api/actual-expenses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error("Error al crear el egreso");return a.json()},onSuccess:()=>{V.invalidateQueries({queryKey:["/api/actual-expenses"]}),S(!1),o.reset(),g({title:"Egreso registrado",description:"El egreso se ha registrado correctamente."})},onError:s=>{g({title:"Error",description:"No se pudo registrar el egreso. Intenta nuevamente.",variant:"destructive"})}}),F=P({mutationFn:async s=>{const a=await fetch(`/api/actual-expenses/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error("Error al actualizar el egreso");return a.json()},onSuccess:()=>{V.invalidateQueries({queryKey:["/api/actual-expenses"]}),N(!1),i(null),g({title:"Egreso actualizado",description:"El egreso se ha actualizado correctamente."})},onError:s=>{g({title:"Error",description:"No se pudo actualizar el egreso. Intenta nuevamente.",variant:"destructive"})}}),q=P({mutationFn:async s=>{const a=await fetch(`/api/actual-expenses/${s}`,{method:"DELETE"});if(!a.ok)throw new Error("Error al eliminar el egreso");return a.json()},onSuccess:()=>{V.invalidateQueries({queryKey:["/api/actual-expenses"]}),f(!1),D(null),g({title:"Egreso eliminado",description:"El egreso se ha eliminado correctamente."})},onError:s=>{g({title:"Error",description:"No se pudo eliminar el egreso. Intenta nuevamente.",variant:"destructive"})}}),te=s=>{k.mutate(s)},oe=s=>{i(s);const a={parkId:s.parkId||3,categoryId:s.categoryId||2,concept:s.concept||"",amount:s.amount||0,description:s.description||"",date:s.date?s.date.split("T")[0]:new Date().toISOString().split("T")[0],vendor:s.vendor||"",notes:s.notes||""};ne.reset(a),N(!0)},B=c.useMemo(()=>{const s=Array.isArray(b)?b.map(v=>({...v,source:"manual",isPayrollGenerated:!1})):[],a=Array.isArray(I)?I.map(v=>({...v,source:"payroll",isPayrollGenerated:!0,vendor:v.supplier||"Nómina Interna"})):[];return[...s,...a]},[b,I]),G=c.useMemo(()=>Array.isArray(B)?B.filter(s=>{var Q;const a=new Date(s.date),v=a.getFullYear().toString(),le=(a.getMonth()+1).toString().padStart(2,"0"),ce=a.toISOString().split("T")[0];return!(n.concept&&!((Q=s.concept)!=null&&Q.toLowerCase().includes(n.concept.toLowerCase()))||n.year&&v!==n.year||n.month&&le!==n.month||n.date&&ce!==n.date||n.category&&s.categoryId.toString()!==n.category)}):[],[b,n]),J=s=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(s),ie=s=>new Date(s).toLocaleDateString("es-MX");return e.jsx(xe,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:e.jsx(_,{className:"h-6 w-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Cédula de Egresos"}),e.jsx("p",{className:"text-gray-600",children:"Gestión y registro de todos los gastos del parque (incluye nómina automática)"})]})]}),e.jsxs(M,{open:ee,onOpenChange:S,children:[e.jsx(ue,{asChild:!0,children:e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Nuevo Egreso"]})}),e.jsxs(L,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(z,{children:"Registrar Nuevo Egreso"}),e.jsx(K,{children:"Complete la información del gasto realizado"})]}),e.jsx(pe,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(te),className:"space-y-4",children:[e.jsx(d,{control:o.control,name:"parkId",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Parque"}),e.jsxs(H,{onValueChange:a=>s.onChange(Number(a)),value:s.value.toString(),children:[e.jsx(u,{children:e.jsx(Y,{children:e.jsx($,{placeholder:"Seleccionar parque"})})}),e.jsx(U,{children:T.map(a=>e.jsx(W,{value:a.id.toString(),children:a.name},a.id))})]}),e.jsx(h,{})]})}),e.jsx(d,{control:o.control,name:"categoryId",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Categoría de Egreso"}),e.jsxs(H,{onValueChange:a=>s.onChange(Number(a)),value:s.value.toString(),children:[e.jsx(u,{children:e.jsx(Y,{children:e.jsx($,{placeholder:"Seleccionar categoría"})})}),e.jsx(U,{children:C.map(a=>e.jsx(W,{value:a.id.toString(),children:a.name},a.id))})]}),e.jsx(h,{})]})}),e.jsx(d,{control:o.control,name:"concept",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Concepto"}),e.jsx(u,{children:e.jsx(t,{placeholder:"Descripción breve del gasto",...s})}),e.jsx(h,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(d,{control:o.control,name:"amount",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Monto"}),e.jsx(u,{children:e.jsx(t,{type:"number",step:"0.01",placeholder:"0.00",value:s.value||"",onChange:a=>s.onChange(parseFloat(a.target.value)||0)})}),e.jsx(h,{})]})}),e.jsx(d,{control:o.control,name:"date",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Fecha"}),e.jsx(u,{children:e.jsx(t,{type:"date",...s})}),e.jsx(h,{})]})})]}),e.jsx(d,{control:o.control,name:"description",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Descripción detallada"}),e.jsx(u,{children:e.jsx(t,{placeholder:"Descripción completa del gasto",...s})}),e.jsx(h,{})]})}),e.jsx(d,{control:o.control,name:"vendor",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Proveedor (opcional)"}),e.jsx(u,{children:e.jsx(t,{placeholder:"Nombre del proveedor",...s})}),e.jsx(h,{})]})}),e.jsx(d,{control:o.control,name:"notes",render:({field:s})=>e.jsxs(m,{children:[e.jsx(x,{children:"Notas adicionales"}),e.jsx(u,{children:e.jsx(t,{placeholder:"Notas opcionales",...s})}),e.jsx(h,{})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>S(!1),children:"Cancelar"}),e.jsxs(l,{type:"submit",disabled:k.isPending,children:[k.isPending&&e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Registrar Egreso"]})]})]})})]})]})]}),e.jsxs(je,{children:[e.jsxs(ge,{children:[e.jsx(ve,{children:"Egresos Registrados"}),e.jsx(ye,{children:"Historial de todos los gastos del parque"})]}),e.jsxs(Ne,{children:[e.jsxs("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 mb-3",children:"Filtros de búsqueda"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsx("div",{children:e.jsx(t,{placeholder:"Buscar por concepto...",value:n.concept,onChange:s=>j(a=>({...a,concept:s.target.value})),className:"h-9"})}),e.jsx("div",{children:e.jsxs("select",{value:n.year,onChange:s=>j(a=>({...a,year:s.target.value})),className:"h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm",children:[e.jsx("option",{value:"",children:"Todos los años"}),e.jsx("option",{value:"2025",children:"2025"}),e.jsx("option",{value:"2024",children:"2024"}),e.jsx("option",{value:"2023",children:"2023"}),e.jsx("option",{value:"2022",children:"2022"}),e.jsx("option",{value:"2021",children:"2021"})]})}),e.jsx("div",{children:e.jsxs("select",{value:n.month,onChange:s=>j(a=>({...a,month:s.target.value})),className:"h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm",children:[e.jsx("option",{value:"",children:"Todos los meses"}),e.jsx("option",{value:"01",children:"Enero"}),e.jsx("option",{value:"02",children:"Febrero"}),e.jsx("option",{value:"03",children:"Marzo"}),e.jsx("option",{value:"04",children:"Abril"}),e.jsx("option",{value:"05",children:"Mayo"}),e.jsx("option",{value:"06",children:"Junio"}),e.jsx("option",{value:"07",children:"Julio"}),e.jsx("option",{value:"08",children:"Agosto"}),e.jsx("option",{value:"09",children:"Septiembre"}),e.jsx("option",{value:"10",children:"Octubre"}),e.jsx("option",{value:"11",children:"Noviembre"}),e.jsx("option",{value:"12",children:"Diciembre"})]})}),e.jsx("div",{children:e.jsx(t,{type:"date",value:n.date,onChange:s=>j(a=>({...a,date:s.target.value})),className:"h-9"})}),e.jsx("div",{children:e.jsxs("select",{value:n.category,onChange:s=>j(a=>({...a,category:s.target.value})),className:"h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})})]}),(n.concept||n.year||n.month||n.date||n.category)&&e.jsx("div",{className:"mt-3",children:e.jsx(l,{variant:"outline",size:"sm",onClick:()=>j({concept:"",year:"",month:"",date:"",category:""}),children:"Limpiar filtros"})})]}),re?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(w,{className:"h-8 w-8 animate-spin mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Cargando egresos..."})]}):e.jsx("div",{className:"space-y-4",children:G.length>0?G.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:s.concept}),s.isPayrollGenerated&&e.jsx(fe,{variant:"secondary",className:"bg-blue-100 text-blue-800 text-xs",children:"Nómina"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.description}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs text-gray-500",children:[e.jsx("span",{children:ie(s.date)}),s.vendor&&e.jsxs("span",{children:["Proveedor: ",s.vendor]})]})]})})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-red-600",children:["-",J(s.amount)]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.categoryName||"Sin categoría"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{variant:"outline",size:"sm",onClick:()=>oe(s),className:"h-8 w-8 p-0",children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(l,{variant:"outline",size:"sm",onClick:()=>{D(s),f(!0)},className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(Ce,{className:"h-4 w-4"})})]})]})]},s.id)):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(_,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No hay egresos registrados"})]})})]})]}),e.jsx(M,{open:se,onOpenChange:N,children:e.jsxs(L,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(z,{children:"Editar Egreso"}),e.jsx(K,{children:"Modifica la información del gasto"})]}),r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Parque"}),e.jsx("select",{value:r.parkId||3,onChange:s=>i({...r,parkId:Number(s.target.value)}),className:"w-full mt-1 p-2 border rounded-md",children:Array.isArray(T)&&T.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Categoría"}),e.jsx("select",{value:r.categoryId||2,onChange:s=>i({...r,categoryId:Number(s.target.value)}),className:"w-full mt-1 p-2 border rounded-md",children:Array.isArray(C)&&C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Concepto"}),e.jsx(t,{value:r.concept||"",onChange:s=>i({...r,concept:s.target.value}),placeholder:"Descripción breve del gasto"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Monto"}),e.jsx(t,{type:"number",step:"0.01",value:r.amount||0,onChange:s=>i({...r,amount:parseFloat(s.target.value)||0})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Fecha"}),e.jsx(t,{type:"date",value:r.date?r.date.split("T")[0]:new Date().toISOString().split("T")[0],onChange:s=>i({...r,date:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Descripción"}),e.jsx(t,{value:r.description||"",onChange:s=>i({...r,description:s.target.value}),placeholder:"Descripción completa del gasto"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Proveedor (opcional)"}),e.jsx(t,{value:r.vendor||"",onChange:s=>i({...r,vendor:s.target.value}),placeholder:"Nombre del proveedor"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Notas"}),e.jsx(t,{value:r.notes||"",onChange:s=>i({...r,notes:s.target.value}),placeholder:"Notas adicionales"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsxs(l,{onClick:()=>{r&&F.mutate({id:r.id,parkId:r.parkId,categoryId:r.categoryId,concept:r.concept,amount:r.amount,description:r.description,date:r.date,vendor:r.vendor,notes:r.notes})},disabled:F.isPending,children:[F.isPending&&e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardar Cambios"]})]})]})]})}),e.jsx(M,{open:ae,onOpenChange:f,children:e.jsxs(L,{className:"max-w-md",children:[e.jsxs(A,{children:[e.jsx(z,{children:"Confirmar Eliminación"}),e.jsx(K,{children:"¿Estás seguro de que deseas eliminar este egreso? Esta acción no se puede deshacer."})]}),p&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium",children:p.concept}),e.jsx("p",{className:"text-sm text-gray-600",children:p.description}),e.jsxs("p",{className:"text-lg font-bold text-red-600 mt-2",children:["-",J(p.amount)]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>{f(!1),D(null)},children:"Cancelar"}),e.jsxs(l,{variant:"destructive",onClick:()=>{p&&q.mutate(p.id)},disabled:q.isPending,children:[q.isPending&&e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Eliminar Egreso"]})]})]})]})})]})})};export{De as default};
