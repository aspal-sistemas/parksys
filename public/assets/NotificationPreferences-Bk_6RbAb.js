import{Y as m,a6 as D,u as N,a8 as W,j as e,aB as X,cr as Y,aH as Z,aI as O,aJ as R,b5 as U,a$ as b,aK as q,C as o,a as v,b as y,U as I,a3 as w,c as x,Z as ee,I as se,B as F,ap as B,z as ae,H as re,J as le,K as ne,N as K,aC as A,f as C,n as te,a9 as _,b6 as ie,ah as ce,bv as M}from"./index-BBGHPKhn.js";import{S as de}from"./separator-avss73FP.js";function he(){var E;const[i,S]=m.useState(null),[l,h]=m.useState(""),[c,k]=m.useState("all"),P=D();m.useEffect(()=>(console.log("🔍 NotificationPreferences component mounted"),()=>{console.log("🔍 NotificationPreferences component unmounted")}),[]);const{data:n,isLoading:$,error:oe}=N({queryKey:["/api/users"],select:s=>(s==null?void 0:s.users)||s||[],retry:3,retryDelay:1e3}),{data:a,isLoading:z}=N({queryKey:[`/api/users/${i}/notification-preferences`],enabled:!!i}),{data:d,error:xe}=N({queryKey:["/api/users/notification-preferences/summary"],retry:3,retryDelay:1e3}),p=W({mutationFn:async({userId:s,preferences:r})=>ce(`/api/users/${s}/notification-preferences`,{method:"PUT",data:r}),onSuccess:()=>{M({title:"Preferencias actualizadas",description:"Las preferencias de notificación se han guardado correctamente."}),P.invalidateQueries({queryKey:[`/api/users/${i}/notification-preferences`]}),P.invalidateQueries({queryKey:["/api/users/notification-preferences/summary"]})},onError:s=>{M({title:"Error",description:(s==null?void 0:s.message)||"No se pudieron actualizar las preferencias.",variant:"destructive"})}});m.useEffect(()=>{if(n&&n.length>0&&!i){const s=n.find(r=>r.role==="admin"||r.role==="super_admin");s&&S(s.id)}},[n,i]);const V=(s,r)=>{if(!a)return;const t={...a.preferences,[s]:r};p.mutate({userId:a.userId,preferences:t})},j=s=>{switch(s){case"admin":return"bg-red-100 text-red-800";case"super_admin":return"bg-purple-100 text-purple-800";case"manager":return"bg-blue-100 text-blue-800";case"instructor":return"bg-green-100 text-green-800";case"volunteer":return"bg-orange-100 text-orange-800";case"concessionaire":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}},u=s=>{switch(s){case"admin":return"Administrador";case"super_admin":return"Super Admin";case"manager":return"Gestor";case"instructor":return"Instructor";case"volunteer":return"Voluntario";case"concessionaire":return"Concesionario";default:return s}},f=(n==null?void 0:n.filter(s=>["admin","super_admin","manager","instructor","volunteer","concessionaire"].includes(s.role)))||[],g=f.filter(s=>{const r=l===""||(s.fullName||s.name||"").toLowerCase().includes(l.toLowerCase())||(s.email||"").toLowerCase().includes(l.toLowerCase()),t=c==="all"||s.role===c;return r&&t}),Q=[...new Set(f.map(s=>s.role))],H=()=>{h(""),k("all")};return e.jsx(X,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(Y,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Preferencias de Notificaciones"}),e.jsx("p",{className:"text-gray-500",children:"Configura qué tipos de notificaciones recibe cada usuario del sistema"})]})]}),e.jsxs(Z,{defaultValue:"configuracion",className:"w-full",children:[e.jsxs(O,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsxs(R,{value:"configuracion",className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"Configuración de Usuario"]}),e.jsxs(R,{value:"resumen",className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-4 w-4"}),"Resumen por Roles"]})]}),e.jsx(q,{value:"configuracion",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(o,{children:[e.jsxs(v,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Seleccionar Usuario"]}),e.jsx(w,{children:"Elige el usuario para configurar sus preferencias"})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"space-y-4 mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),e.jsx(se,{placeholder:"Buscar por nombre o email...",value:l,onChange:s=>h(s.target.value),className:"pl-9 pr-9"}),l&&e.jsx(F,{variant:"ghost",size:"sm",onClick:()=>h(""),className:"absolute right-1 top-1 h-8 w-8 p-0 hover:bg-gray-100",children:e.jsx(B,{className:"h-4 w-4"})})]}),e.jsxs(ae,{value:c,onValueChange:k,children:[e.jsx(re,{children:e.jsx(le,{placeholder:"Filtrar por rol"})}),e.jsxs(ne,{children:[e.jsx(K,{value:"all",children:"Todos los roles"}),Q.map(s=>e.jsx(K,{value:s,children:u(s)},s))]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-500",children:[e.jsxs("span",{children:[g.length," de ",f.length," usuarios"]}),(l||c!=="all")&&e.jsxs(F,{variant:"ghost",size:"sm",onClick:H,className:"h-6 text-xs",children:[e.jsx(B,{className:"h-3 w-3 mr-1"}),"Limpiar"]})]})]}),$?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(s=>e.jsx("div",{className:"h-12 bg-gray-200 animate-pulse rounded"},s))}):g.length===0?e.jsxs("div",{className:"p-4 text-center text-gray-500",children:[e.jsx(A,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),e.jsx("p",{className:"font-medium mb-1",children:l||c!=="all"?"Sin resultados":"No hay usuarios"}),e.jsx("p",{className:"text-xs",children:l||c!=="all"?"Prueba ajustando los filtros de búsqueda":"No se encontraron usuarios relevantes"})]}):e.jsx("div",{className:"space-y-2 max-h-80 overflow-y-auto",children:g.map(s=>e.jsx("div",{onClick:()=>S(s.id),className:`p-3 rounded-lg border cursor-pointer transition-colors ${i===s.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.fullName||s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.email})]}),e.jsx(C,{className:j(s.role),variant:"secondary",children:u(s.role)})]})},s.id))})]})]}),e.jsx("div",{className:"lg:col-span-2",children:z?e.jsx(o,{children:e.jsxs(x,{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Cargando preferencias..."})]})}):a?e.jsxs(o,{children:[e.jsxs(v,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),"Preferencias de ",a.fullName||"Usuario"]}),e.jsx(w,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),a.email,e.jsx(C,{className:j(a.role),variant:"secondary",children:u(a.role)})]})})]}),e.jsxs(x,{className:"space-y-4",children:[((E=a.availableNotifications)==null?void 0:E.map((s,r)=>{var L,T;const t=s.key.startsWith("feedback_"),G=s.key==="feedback";return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"flex items-center gap-2",children:G?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"font-semibold text-sm text-blue-800",children:s.label})]}):t?e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx("div",{className:"w-3 h-px bg-gray-300"}),e.jsx(_,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"font-medium text-xs",children:s.label.replace("  └─ ","")})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"font-medium text-sm",children:s.label})]})}),e.jsx("p",{className:`text-xs text-gray-500 ${t?"ml-8":"ml-6"}`,children:s.description})]}),e.jsx(ie,{checked:((L=a.preferences)==null?void 0:L[s.key])||!1,onCheckedChange:J=>V(s.key,J),disabled:p.isPending,className:t?"scale-90":""})]}),r<(((T=a.availableNotifications)==null?void 0:T.length)||0)-1&&e.jsx(de,{className:"mt-4"})]},s.key)}))||e.jsxs("div",{className:"p-4 text-center text-gray-500",children:[e.jsx(A,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),e.jsx("p",{children:"No hay preferencias de notificación disponibles para este usuario"})]}),p.isPending&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-600",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),"Guardando cambios..."]})]})]}):e.jsx(o,{children:e.jsxs(x,{className:"p-8 text-center",children:[e.jsx(I,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Selecciona un usuario"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Elige un usuario de la lista para configurar sus preferencias de notificación"})]})})})]})}),e.jsx(q,{value:"resumen",children:d!=null&&d.summary&&Array.isArray(d.summary)&&d.summary.length>0?e.jsxs(o,{children:[e.jsxs(v,{children:[e.jsxs(y,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5"}),"Resumen por Roles"]}),e.jsx(w,{children:"Vista general de las preferencias de notificación por tipo de usuario"})]}),e.jsx(x,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:d.summary.map(s=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(C,{className:j(s.role),children:u(s.role)}),e.jsxs("span",{className:"text-sm text-gray-500",children:[s.total_users," usuarios"]})]}),e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Feedback general:"}),e.jsxs("span",{className:"font-medium",children:[s.feedback_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between ml-2",children:[e.jsx("span",{children:"├ Experiencias:"}),e.jsxs("span",{className:"font-medium text-green-600",children:[s.feedback_share_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between ml-2",children:[e.jsx("span",{children:"├ Problemas:"}),e.jsxs("span",{className:"font-medium text-red-600",children:[s.feedback_report_problem_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between ml-2",children:[e.jsx("span",{children:"├ Mejoras:"}),e.jsxs("span",{className:"font-medium text-blue-600",children:[s.feedback_suggest_improvement_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between ml-2",children:[e.jsx("span",{children:"└ Eventos:"}),e.jsxs("span",{className:"font-medium text-purple-600",children:[s.feedback_propose_event_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between pt-1",children:[e.jsx("span",{children:"Eventos:"}),e.jsxs("span",{className:"font-medium",children:[s.events_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Mantenimiento:"}),e.jsxs("span",{className:"font-medium",children:[s.maintenance_enabled,"/",s.total_users]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Nómina:"}),e.jsxs("span",{className:"font-medium",children:[s.payroll_enabled,"/",s.total_users]})]})]})]},s.role))})})]}):e.jsx(o,{children:e.jsxs(x,{className:"p-8 text-center",children:[e.jsx(b,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Sin datos de resumen"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No hay datos disponibles para mostrar el resumen por roles"})]})})})]})]})})}export{he as default};
